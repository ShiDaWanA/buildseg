import{d as Me,D as Se,r as T,a as pt,c as y,e as G,h as a,w as n,F as ae,o as I,i as L,m as K,f as D,q as ge,z as he,l as U,E as te,J as Qe,K as Ye,t as me,M as Lt,a0 as Ct,H as mt,g as N,N as Ze,a1 as kt,L as Be,a2 as Tt,O as Vt,p as Rt,n as Pt,_ as St,S as Et,a3 as Dt,P as et,U as Ft,a4 as Mt,W as Nt,X as $t,T as At,A as Bt,a5 as Ot}from"./index-ab68adb5.js";import{_ as Ut}from"./mac-folder-48-c5b4c709.js";import{_ as gt}from"./picture-48-70f98f1e.js";import{B as Xe,u as Gt}from"./useSetting-1e631b4e.js";import{B as zt}from"./BaseTitle-588acb84.js";import{B as ft}from"./BaseTreeSelect-895cd5e4.js";import{E as qt,x as vt,y as tt,C as Ht,z as Xt,A as at,B as Fe,D as ht,I as ve,G as Oe,H as Jt,J as Ue,K as Ge,L as ze,N as Wt,Q as jt,R as Kt,U as Qt,W as Yt,X as Zt,Y as ea,Z as ta,$ as aa,a0 as la,a1 as Te,a2 as oa,a3 as Ne,a4 as na,S as Ee,u as qe,v as De,a5 as _t,P as $e,a6 as He,M as sa,V as ra,d as ia,p as lt,_ as ot,a as da,a7 as nt,r as ua,F as Re,a8 as Ae,a9 as ca,aa as pa}from"./ImageInfo.vue_vue_type_script_setup_true_lang-abee9b6f.js";import{c as ma,g as st,M as ga,S as fa,V as va,u as ha,a as Pe,_ as _a,b as rt}from"./useTag-af0a58db.js";import{c as it,a as ya}from"./map-6df5e062.js";import"./format-aee67674.js";import"./index-f53ede3a.js";class ba extends qt{constructor(e,l,d,s){super(),this.extent=e,this.pixelRatio_=d,this.resolution=l,this.state=s}changed(){this.dispatchEvent(vt.CHANGE)}getExtent(){return this.extent}getImage(){return tt()}getPixelRatio(){return this.pixelRatio_}getResolution(){return this.resolution}getState(){return this.state}load(){tt()}}const xa=ba;class wa extends Ht{constructor(e){super(e),this.image_=null}getImage(){return this.image_?this.image_.getImage():null}prepareFrame(e){const l=e.layerStatesArray[e.layerIndex],d=e.pixelRatio,s=e.viewState,r=s.resolution,u=this.getLayer().getSource(),o=e.viewHints;let v=e.extent;if(l.extent!==void 0&&(v=Xt(v,at(l.extent,s.projection))),!o[Fe.ANIMATING]&&!o[Fe.INTERACTING]&&!ht(v))if(u){const _=s.projection,C=u.getImage(v,r,d,_);C&&(this.loadImage(C)?this.image_=C:C.getState()===ve.EMPTY&&(this.image_=null))}else this.image_=null;return!!this.image_}getData(e){const l=this.frameState;if(!l)return null;const d=this.getLayer(),s=Oe(l.pixelToCoordinateTransform,e.slice()),r=d.getExtent();if(r&&!Jt(r,s))return null;const u=this.image_.getExtent(),o=this.getImage(),v=Ue(u),_=Math.floor(o.width*((s[0]-u[0])/v));if(_<0||_>=o.width)return null;const C=Ge(u),w=Math.floor(o.height*((u[3]-s[1])/C));return w<0||w>=o.height?null:this.getImageData(o,_,w)}renderFrame(e,l){const d=this.image_,s=d.getExtent(),r=d.getResolution(),u=d.getPixelRatio(),o=e.layerStatesArray[e.layerIndex],v=e.pixelRatio,_=e.viewState,C=_.center,w=_.resolution,Q=v*r/(w*u),$=e.extent,x=_.resolution,h=_.rotation,p=Math.round(Ue($)/x*v),i=Math.round(Ge($)/x*v);ze(this.pixelTransform,e.size[0]/2,e.size[1]/2,1/v,1/v,h,-p/2,-i/2),Wt(this.inversePixelTransform,this.pixelTransform);const m=jt(this.pixelTransform);this.useContainer(l,m,this.getBackground(e));const c=this.context,k=c.canvas;k.width!=p||k.height!=i?(k.width=p,k.height=i):this.containerReused||c.clearRect(0,0,p,i);let R=!1,P=!0;if(o.extent){const z=at(o.extent,_.projection);P=Kt(z,e.extent),R=P&&!Qt(z,e.extent),R&&this.clipUnrotated(c,e,z)}const S=this.getImage(),V=ze(this.tempTransform,p/2,i/2,Q,Q,0,u*(s[0]-C[0])/r,u*(C[1]-s[3])/r);this.renderedResolution=r*v/u;const re=S.width*V[0],le=S.height*V[3];if(this.getLayer().getSource().getInterpolate()||(c.imageSmoothingEnabled=!1),this.preRender(c,e),P&&re>=.5&&le>=.5){const z=V[4],q=V[5],ie=o.opacity;let de;ie!==1&&(de=c.globalAlpha,c.globalAlpha=ie),c.drawImage(S,0,0,+S.width,+S.height,z,q,re,le),ie!==1&&(c.globalAlpha=de)}return this.postRender(c,e),R&&c.restore(),c.imageSmoothingEnabled=!0,m!==k.style.transform&&(k.style.transform=m),this.container}}const Ia=wa;class La extends xa{constructor(e,l,d,s,r){const u=r!==void 0?ve.IDLE:ve.LOADED;super(e,l,d,u),this.loader_=r!==void 0?r:null,this.canvas_=s,this.error_=null}getError(){return this.error_}handleLoad_(e){e?(this.error_=e,this.state=ve.ERROR):this.state=ve.LOADED,this.changed()}load(){this.state==ve.IDLE&&(this.state=ve.LOADING,this.changed(),this.loader_(this.handleLoad_.bind(this)))}getImage(){return this.canvas_}}const Ca=La;class ka extends Ia{constructor(e){super(e),this.vectorRenderer_=new Yt(e),this.layerImageRatio_=e.getImageRatio(),this.coordinateToVectorPixelTransform_=Zt(),this.renderedPixelToCoordinateTransform_=null}disposeInternal(){this.vectorRenderer_.dispose(),super.disposeInternal()}getFeatures(e){if(!this.vectorRenderer_)return Promise.resolve([]);const l=Oe(this.coordinateToVectorPixelTransform_,Oe(this.renderedPixelToCoordinateTransform_,e.slice()));return this.vectorRenderer_.getFeatures(l)}handleFontsChanged(){this.vectorRenderer_.handleFontsChanged()}prepareFrame(e){const l=e.pixelRatio,d=e.viewState,s=d.resolution,r=e.viewHints,u=this.vectorRenderer_;let o=e.extent;this.layerImageRatio_!==1&&(o=o.slice(0),ea(o,this.layerImageRatio_));const v=Ue(o)/s,_=Ge(o)/s;if(!r[Fe.ANIMATING]&&!r[Fe.INTERACTING]&&!ht(o)){u.useContainer(null,null);const C=u.context,w=e.layerStatesArray[e.layerIndex];C.globalAlpha=w.opacity;const Q=Object.assign({},w,{opacity:1}),$=Object.assign({},e,{declutterTree:new ta(9),extent:o,size:[v,_],viewState:Object.assign({},e.viewState,{rotation:0}),layerStatesArray:[Q],layerIndex:0});let x=!0;const h=new Ca(o,s,l,C.canvas,function(p){u.prepareFrame($)&&u.replayGroupChanged&&(u.clipping=!1,u.renderFrame($,null)&&(u.renderDeclutter($),x=!1),p())});h.addEventListener(vt.CHANGE,()=>{if(h.getState()!==ve.LOADED)return;this.image_=x?null:h;const p=h.getResolution(),i=h.getPixelRatio(),m=p*l/i;this.renderedResolution=m,this.coordinateToVectorPixelTransform_=ze(this.coordinateToVectorPixelTransform_,v/2,_/2,1/m,-1/m,0,-d.center[0],-d.center[1])}),h.load()}return this.image_&&(this.renderedPixelToCoordinateTransform_=e.pixelToCoordinateTransform.slice()),!!this.image_}preRender(){}postRender(){}renderDeclutter(){}forEachFeatureAtCoordinate(e,l,d,s,r){return this.vectorRenderer_?this.vectorRenderer_.forEachFeatureAtCoordinate(e,l,d,s,r):super.forEachFeatureAtCoordinate(e,l,d,s,r)}}const Ta=ka;class Va extends aa{constructor(e){e=e||{};const l=Object.assign({},e);delete l.imageRatio,super(l),this.imageRatio_=e.imageRatio!==void 0?e.imageRatio:1}getImageRatio(){return this.imageRatio_}createRenderer(){return new Ta(this)}}const Ra=Va,Pa=D("span",{style:{padding:"8px 16px",display:"inline-block","border-radius":"4px","background-color":"#f4f4f5",color:"#909399","font-size":"13px","line-height":"18px"}},[L(" 通过文件名称头部或尾部字符进行配对，如：LC08_L1TP_"),D("span",{style:{color:"#67c23a"}},"QT"),L("，LC08_L1TP_"),D("span",{style:{color:"#67c23a"}},"HT"),L("，可通过尾部两位匹配成功 ")],-1),Sa={style:{"font-size":"20px",color:"#909399",padding:"8px 16px","border-radius":"4px",border:"1px solid #ebeef5",margin:"16px 0","text-align":"center"}},Ea={key:0,style:{color:"#409eff"}},Da=D("span",null,"XXX..XXX",-1),Fa={key:1,style:{color:"#67c23a"}},Ma={style:{display:"flex","justify-content":"space-around","align-items":"center"}},Na=Me({__name:"DatasetAddImage",props:["modelValue","pair","datasetId"],emits:["update:modelValue","success"],setup(t,{emit:e}){const l=t,d=()=>{e("update:modelValue",!1)},s=Se(()=>l.modelValue),r=T(!1),u=pt({isLastPart:!1,charLength:2}),o=T(),v=async(p,i)=>{let m;p.level!=0&&(m=p.data.id);let c=await U.get("api/catalog/GetFolders",{params:{folderId:m}});c.forEach(P=>{P.picture="folder-upload-48.png"});let k=await U.get("api/catalog/GetImagesInFolder",{params:{folderId:m}});k.forEach(P=>{P.leaf=!0,P.picture="picture-48.png"});let R=[...c,...k];return i(R)},_=p=>{let i=o.value.getCheckedNodes();if(i.length==0){te.error("请选择影像");return}let m=i.map(c=>c.id);U.post("api/Label/"+p,{DatasetId:l.datasetId,ImageIds:m}).then(c=>{x(),p=="CreateImagePair"&&h(c)})},C=T(),w=()=>{var p;(p=C.value)==null||p.$el.querySelector("input").click()},Q=p=>{const i=new FileReader,m=p.raw;i.readAsText(m),i.onload=()=>{let c=i.result.split(`\r
`),k=[];c.forEach(S=>{S.trim()!=""&&k.push(S.split(","))});let R=o.value.getCheckedNodes(!0);if(R.length==0){te.error("请选择影像");return}r.value=!1;let P=R.map(S=>S.id);U.post("api/Label/CreateImagePairByTable",{DatasetId:l.datasetId,ImageIds:P,PairParams:{PairTable:k}}).then(S=>{x(),h(S)})}},$=()=>{let p=o.value.getCheckedNodes(!0);if(p.length==0){te.error("请选择影像");return}r.value=!1;let i=p.map(m=>m.id);U.post("api/Label/CreateImagePairByName",{DatasetId:l.datasetId,ImageFileIds:i,PairParams:{CharLength:u.charLength,IsLastPart:u.isLastPart}}).then(m=>{x(),h(m)})},x=()=>{e("success"),e("update:modelValue",!1)},h=p=>{p>0?te({message:"匹配成功 "+p+" 对影像",type:"success"}):te({message:"未匹配成功",type:"info"})};return(p,i)=>{const m=y("el-button"),c=y("el-button-group"),k=y("el-upload"),R=y("el-dialog"),P=y("el-switch"),S=y("el-input-number");return I(),G(ae,null,[a(R,{title:"选择影像",modelValue:s.value,"onUpdate:modelValue":i[4]||(i[4]=V=>s.value=V),"close-on-click-modal":!1,width:"500px",onClosed:d},{footer:n(()=>[a(m,{onClick:d},{default:n(()=>[L("取消")]),_:1}),t.pair?(I(),K(c,{key:0,style:{"margin-left":"16px"}},{default:n(()=>[a(m,{type:"primary",onClick:i[0]||(i[0]=V=>_("CreateImagePair"))},{default:n(()=>[L("空间关系配对")]),_:1}),a(m,{type:"primary",onClick:i[1]||(i[1]=V=>r.value=!0)},{default:n(()=>[L("名称配对")]),_:1}),a(m,{type:"primary",onClick:i[2]||(i[2]=V=>w())},{default:n(()=>[L("关系表配对")]),_:1})]),_:1})):(I(),K(m,{key:1,type:"primary",onClick:i[3]||(i[3]=V=>_("Create"))},{default:n(()=>[L("确定")]),_:1})),a(k,{ref_key:"uploadPairTableRef",ref:C,accept:".txt,.csv","auto-upload":!1,"show-file-list":!1,action:"","on-change":Q,style:{display:"none"}},null,512)]),default:n(()=>[a(ft,{ref_key:"imageTreeSelectRef",ref:o,"load-node":v,"single-selection":!1},null,512)]),_:1},8,["modelValue"]),a(R,{title:"配对规则",modelValue:r.value,"onUpdate:modelValue":i[9]||(i[9]=V=>r.value=V),"close-on-click-modal":!1,width:"350px"},{footer:n(()=>[a(m,{onClick:i[7]||(i[7]=V=>r.value=!1)},{default:n(()=>[L("取消")]),_:1}),a(m,{type:"primary",onClick:i[8]||(i[8]=V=>$())},{default:n(()=>[L("确定")]),_:1})]),default:n(()=>[Pa,D("div",Sa,[u.isLastPart?he("",!0):(I(),G("span",Ea,[(I(!0),G(ae,null,ge(u.charLength,V=>(I(),G("span",{key:V},"A"))),128))])),Da,u.isLastPart?(I(),G("span",Fa,[(I(!0),G(ae,null,ge(u.charLength,V=>(I(),G("span",{key:V},"A"))),128))])):he("",!0)]),D("div",Ma,[a(P,{modelValue:u.isLastPart,"onUpdate:modelValue":i[5]||(i[5]=V=>u.isLastPart=V),"active-color":"#67c23a","inactive-color":"#409EFF","active-text":"尾部","inactive-text":"头部"},null,8,["modelValue"]),a(S,{size:"mini",min:1,modelValue:u.charLength,"onUpdate:modelValue":i[6]||(i[6]=V=>u.charLength=V)},null,8,["modelValue"])])]),_:1},8,["modelValue"])],64)}}}),$a={style:{"text-align":"right"}},Aa={style:{"margin-top":"10px"}},Ba=D("span",{style:{"font-size":"14px"}},"→",-1),Oa={style:{"text-align":"right"}},Ua=Me({__name:"TagRelate",emits:["complate"],setup(t,{expose:e,emit:l}){const d=T(!1),s=T(0),r=T(""),u=T(),o=T([]),v=T(),_=T(),C=T(0);let w;e({show:(m,c,k)=>{d.value=!0,v.value=m,_.value=c,r.value=m[0],C.value=k.features.length,w=k}});const $=()=>{s.value=0,r.value="",o.value=[],u.value=[]},x=()=>{s.value=0,o.value=[],u.value=[]},h=()=>{s.value=1,o.value=[],u.value=[];let m={};for(const c of w.features){let k=c.properties[r.value];k.toString().trim()!=""&&!m[k]&&(o.value.push({shapefileTagName:k.toString().trim(),selectedTagId:_.value[0].id,disable:!0}),m[k]=1)}o.value[0].disable=!1,u.value.push(o.value[0].shapefileTagName)},p=()=>{let m=o.value.filter(c=>c.disable==!1);l("complate",r.value,m),d.value=!1},i=m=>{o.value.forEach(c=>{m.indexOf(c.shapefileTagName)>=0?c.disable=!1:c.disable=!0})};return(m,c)=>{const k=y("el-step"),R=y("el-steps"),P=y("el-option"),S=y("el-select"),V=y("el-form-item"),re=y("el-form"),le=y("el-divider"),z=y("el-button"),q=y("el-checkbox"),ie=y("el-checkbox-group"),de=y("el-alert"),we=y("el-dialog");return I(),K(we,{title:"配置标注",modelValue:d.value,"onUpdate:modelValue":c[5]||(c[5]=O=>d.value=O),"close-on-click-modal":!1,onClose:$,width:"500px","append-to-body":""},{default:n(()=>[a(R,{active:s.value,simple:""},{default:n(()=>[a(k,{title:"选择字段"}),a(k,{title:"配置标注"})]),_:1},8,["active"]),Qe(D("div",null,[D("p",null,"要素个数："+me(C.value),1),a(re,{"label-position":"top"},{default:n(()=>[a(V,{label:"标注字段"},{default:n(()=>[a(S,{modelValue:r.value,"onUpdate:modelValue":c[0]||(c[0]=O=>r.value=O),placeholder:"请选择标注字段",style:{width:"100%"}},{default:n(()=>[(I(!0),G(ae,null,ge(v.value,(O,J)=>(I(),K(P,{key:J,label:O,value:O},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(le),D("div",$a,[a(z,{onClick:c[1]||(c[1]=O=>d.value=!1),plain:""},{default:n(()=>[L("取消")]),_:1}),a(z,{type:"primary",onClick:c[2]||(c[2]=O=>h())},{default:n(()=>[L("下一步")]),_:1})])],512),[[Ye,s.value===0]]),Qe(D("div",Aa,[a(ie,{modelValue:u.value,"onUpdate:modelValue":c[3]||(c[3]=O=>u.value=O),min:1,onChange:i,style:{"max-height":"300px",overflow:"auto"}},{default:n(()=>[(I(!0),G(ae,null,ge(o.value,O=>(I(),G("div",{key:O.index,style:{display:"flex","justify-content":"space-evenly","align-items":"center","margin-bottom":"16px"}},[a(q,{label:O.shapefileTagName,border:""},null,8,["label"]),Ba,a(S,{modelValue:O.selectedTagId,"onUpdate:modelValue":J=>O.selectedTagId=J,placeholder:"请选择",disabled:O.disable},{default:n(()=>[(I(!0),G(ae,null,ge(_.value,J=>(I(),K(P,{key:J.id,label:J.name,value:J.id},{default:n(()=>[a(Xe,{name:J.name,color:J.color},null,8,["name","color"])]),_:2},1032,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"])]))),128))]),_:1},8,["modelValue"]),a(de,{title:"在左侧列中勾选需要导入的地类，在右侧列中选择系统中对应地类",type:"info"}),a(le),D("div",Oa,[a(z,{onClick:c[4]||(c[4]=O=>d.value=!1),plain:""},{default:n(()=>[L("取消")]),_:1}),a(z,{type:"primary",onClick:x},{default:n(()=>[L("上一步")]),_:1}),a(z,{type:"primary",onClick:p},{default:n(()=>[L("上传")]),_:1})])],512),[[Ye,s.value===1]])]),_:1},8,["modelValue"])}}});function Ga(t){if(!t)throw new Error("geojson is required");switch(t.type){case"Feature":return yt(t);case"FeatureCollection":return za(t);case"Point":case"LineString":case"Polygon":case"MultiPoint":case"MultiLineString":case"MultiPolygon":case"GeometryCollection":return Je(t);default:throw new Error("unknown GeoJSON type")}}function yt(t){var e={type:"Feature"};return Object.keys(t).forEach(function(l){switch(l){case"type":case"properties":case"geometry":return;default:e[l]=t[l]}}),e.properties=bt(t.properties),e.geometry=Je(t.geometry),e}function bt(t){var e={};return t&&Object.keys(t).forEach(function(l){var d=t[l];typeof d=="object"?d===null?e[l]=null:Array.isArray(d)?e[l]=d.map(function(s){return s}):e[l]=bt(d):e[l]=d}),e}function za(t){var e={type:"FeatureCollection"};return Object.keys(t).forEach(function(l){switch(l){case"type":case"features":return;default:e[l]=t[l]}}),e.features=t.features.map(function(l){return yt(l)}),e}function Je(t){var e={type:t.type};return t.bbox&&(e.bbox=t.bbox),t.type==="GeometryCollection"?(e.geometries=t.geometries.map(function(l){return Je(l)}),e):(e.coordinates=xt(t.coordinates),e)}function xt(t){var e=t;return typeof e[0]!="object"?e.slice():e.map(function(l){return xt(l)})}function dt(t,e){return e===void 0&&(e={}),qa(t,"wgs84",e)}function qa(t,e,l){l===void 0&&(l={}),l=l||{};var d=l.mutate;if(!t)throw new Error("geojson is required");return Array.isArray(t)&&la(t[0])?t=e==="mercator"?ut(t):ct(t):(d!==!0&&(t=Ga(t)),ma(t,function(s){var r=e==="mercator"?ut(s):ct(s);s[0]=r[0],s[1]=r[1]})),t}function ut(t){var e=Math.PI/180,l=6378137,d=20037508342789244e-9,s=Math.abs(t[0])<=180?t[0]:t[0]-Ha(t[0])*360,r=[l*s*e,l*Math.log(Math.tan(Math.PI*.25+.5*t[1]*e))];return r[0]>d&&(r[0]=d),r[0]<-d&&(r[0]=-d),r[1]>d&&(r[1]=d),r[1]<-d&&(r[1]=-d),r}function ct(t){var e=180/Math.PI,l=6378137;return[t[0]*e/l,(Math.PI*.5-2*Math.atan(Math.exp(-t[1]/l)))*e]}function Ha(t){return t<0?-1:t>0?1:0}function wt(t,e,l){if(l===void 0&&(l={}),l.final===!0)return Xa(t,e);var d=st(t),s=st(e),r=Te(d[0]),u=Te(s[0]),o=Te(d[1]),v=Te(s[1]),_=Math.sin(u-r)*Math.cos(v),C=Math.cos(o)*Math.sin(v)-Math.sin(o)*Math.cos(v)*Math.cos(u-r);return oa(Math.atan2(_,C))}function Xa(t,e){var l=wt(e,t);return l=(l+180)%360,l}function Ja(t,e){const l=$=>{let x={};const h=[255,255,255,1],p=[0,0,255,1],i=3;return x.Polygon=[new Ee({fill:new qe({color:[255,255,255,.3]}),stroke:new De({color:"#00FF00"})})],x.MultiPolygon=x.Polygon,x.LineString=[new Ee({stroke:new De({color:[0,255,0,.3],width:i})})],x.Point=[new Ee({image:new _t({radius:i*2,fill:new qe({color:p}),stroke:new De({color:h,width:i/2})}),zIndex:1/0})],x[$.getGeometry().getType()]},d=($,x)=>{var h=dt(He($)),p=dt(He(x));return Te(wt(h,p))},s=($,x,h)=>{let p=x[1]-$[1],i=$[0]-x[0],m=x[0]*$[1]-$[0]*x[1];return p*h[0]+i*h[1]+m},r=($,x)=>{let h=$[0],p=h[0],i=h[1],m=h[2];if(x||(x=new $e([])),h.length==3){let S=h.slice();S.push(p);let re=new $e([S]).getArea(),le=Math.sqrt(Math.pow(p[0]-i[0],2)+Math.pow(p[1]-i[1],2)),z=s(p,i,m),q=re*2/le;q=z<0?q:-1*q;var c=d(p,i);c=c-Math.PI*.5;var k=q*Math.sin(c),R=q*Math.cos(c),P=[];P.push(p),P.push(i),P.push([i[0]+k,i[1]+R]),P.push([p[0]+k,p[1]+R]),P.push(p),x?x.setCoordinates([P]):x=new $e([P])}return x};let u=new ga({source:e}),o,v;return{drawPolygon:()=>{t.addInteraction(u),o=new Ne({source:e,type:"Polygon"}),t.addInteraction(o),v=new fa({source:e}),t.addInteraction(v)},drawRectangle:()=>{t.addInteraction(u),o=new Ne({source:e,type:"Polygon",geometryFunction:r,maxPoints:3,style:l}),t.addInteraction(o)},drawBox:()=>{t.addInteraction(u),o=new Ne({source:e,type:"Circle",geometryFunction:na()}),t.addInteraction(o)},stopDraw:()=>{t.removeInteraction(o),t.removeInteraction(u)}}}function Wa(t,e){const l=T([]),d=()=>{t.on("click",r)},s=()=>{t.un("click",r)},r=o=>{e.getFeatures(o.pixel).then(v=>{const _=v[0];_&&(l.value.push(_.getId()),e.changed())})};return{deletedFeatureIds:l,startDeleteFeature:d,stopDeleteFeature:s,undoLastDelete:()=>{l.value.pop(),e.changed()}}}const It=t=>(Rt("data-v-1ea8947b"),t=t(),Pt(),t),ja={class:"map-dialog"},Ka={class:"map-dialog-header"},Qa={class:"map-dialog-title"},Ya={class:"flex-gap-8",style:{"align-items":"center"}},Za=It(()=>D("i",{class:"iconfont icon-undo"},null,-1)),el=It(()=>D("i",{class:"iconfont icon-save"},null,-1)),tl={id:"map",class:"map"},al=Me({__name:"ImageLabel",props:{imageLabel:{type:Object,default:()=>{}}},emits:["close"],async setup(t,{emit:e}){let l,d;const s=t,r=T("view"),u=T();let o=new sa({view:new ra({projection:"EPSG:3857"}),controls:ia({attribution:!1,rotate:!1,zoom:!1})});Lt("map",o);let v=new lt,_,C=new va({declutter:!0});const w=([l,d]=Ct(()=>U.get("api/Tag/GetAll")),l=await l,d(),l),{getTagStyle:Q,defaultTagStyle:$}=ha(o,w),{drawRectangle:x,drawPolygon:h,drawBox:p,stopDraw:i}=Ja(o,v),{startDeleteFeature:m,stopDeleteFeature:c,undoLastDelete:k,deletedFeatureIds:R}=Wa(o,C),P=T(""),S=T(!1);mt(()=>{w.length>0&&(P.value=w[0].id),s.imageLabel.nextImage&&(S.value=!0),u.value={boundingBox:s.imageLabel.boundingBox,numberOfBands:s.imageLabel.image.numberOfBands,rgbBand:s.imageLabel.image.rgbBand},re(s.imageLabel.image.resolution),de()});const V=T(50),re=E=>{o.setTarget("map");let B=it(s.imageLabel.layerName,s.imageLabel.boundingBox,E);if(o.addLayer(B),s.imageLabel.nextImage){let ee=it(s.imageLabel.nextLayerName,s.imageLabel.boundingBox,E);o.addLayer(ee),ee.on("prerender",j=>{var Y=j.context,se=o.getSize(),ue=se[0]*(V.value/100),xe=Pe(j,[ue,0]),H=Pe(j,[se[0],0]),X=Pe(j,[ue,se[1]]),F=Pe(j,se);Y.save(),Y.beginPath(),Y.moveTo(xe[0],xe[1]),Y.lineTo(X[0],X[1]),Y.lineTo(F[0],F[1]),Y.lineTo(H[0],H[1]),Y.closePath(),Y.clip()}),ee.on("postrender",j=>{var Y=j.context;Y.restore()})}new Ra({source:v,style:ee=>S.value?$:Q(ee,.3)}).setMap(o),o.getView().fit(s.imageLabel.boundingBox),v.on("addfeature",le)},le=E=>{S.value||E.feature.setProperties({TagId:P.value,fid:E.feature.getId()})},z=()=>{o&&o.render()},q=()=>{o.setTarget(void 0),o=void 0,e("close")},ie=E=>{switch(c(),i(),E){case"delete":m();break;case"draw":s.imageLabel.type==="rdet"?x():s.imageLabel.type==="det"?p():h();break}},de=()=>{_=ya(s.imageLabel.id),C.setSource(_),C.setExtent(s.imageLabel.boundingBox),C.setStyle(E=>{if(!R.value.includes(E.getId()))return S.value?$:Q(E,.05)}),C.setMap(o)},we=()=>{let E=new nt().writeFeatures(v.getFeatures(),{decimals:4});U.post("/api/Label/UpdateFeatrues",{ExampleId:s.imageLabel.id,GeoJSON:E,DeletedFeatureIds:R.value}).then(()=>{te({message:"保存成功",type:"success"}),R.value=[],v.clear(),_.refresh(),C.changed()})},O=()=>{U.post("/api/Label/DeleteLabelFileAndServer/"+s.imageLabel.id).then(()=>{v.clear(),_.refresh(),C.changed(),te({message:"清空成功",type:"success"})})},J=T();let b;const g=(E,B)=>{if(b=E,S.value)M(null,null);else{let A=Object.keys(B.features[0].properties);J.value.show(A,w,B)}},M=(E,B)=>{let A=new FormData;A.append("file",b),A.append("id",s.imageLabel.id),A.append("fieldName",E),A.append("relationals",JSON.stringify(B)),U.post("/api/Label/UploadShapeFile",A).then(()=>{te({message:"标注上传成功",type:"success"}),_.refresh(),C.changed()})},W=T(!1),Z=T(!0),ke=T(!1);let _e=null,oe=null,ne=null,Ie=null,ce=null,Ve=null,fe=[],ye=[],be=null;const f=async()=>W.value==!1?(o.on("moveend",We),o.on("movestart",pe),o.on("click",je),oe=new lt,ne=new ua({source:oe,style:E=>{let B=E.get("type"),A=B=="pos"?[76,175,80,.8]:[233,30,99,.8],Le=B=="pos"?[76,175,80,.2]:[233,30,99,.2];return new Ee({image:new _t({radius:5,fill:new qe({color:A}),stroke:new De({color:Le,width:4})})})}}),ne.setMap(o),Z.value=!1,await U.post("api/Sam/Init"),Ke(),!0):(o.un("moveend",We),o.un("movestart",pe),o.un("click",je),oe.clear(),await U.post("api/Sam/Release"),Z.value=!0,!0),pe=()=>{W.value&&(_e&&(window.clearTimeout(_e),_e=null),oe.clear(),Z.value=!1)},We=()=>{W.value&&(_e=window.setTimeout(()=>{Ke()},500))};document.addEventListener("keydown",E=>{E.key=="Shift"&&(ke.value=!0)}),document.addEventListener("keyup",E=>{E.key=="Shift"&&(ke.value=!1)});const je=async E=>{if(!Z.value)return;let B=E.coordinate,A=E.pixel_,ee=o.getView().getResolution();var j=He(B);if(rt(j,Ve)){if(ke.value&&Ie!=null){let se=await ne.getFeatures(E.pixel);if(se.length>0){let ue=se[0],xe=ue.get("type"),H=ue.get("pixel");if(xe=="pos"){let X=fe.findIndex(F=>F==H);fe.splice(X,1)}else{let X=ye.findIndex(F=>F==H);ye.splice(X,1)}if(oe.removeFeature(ue),fe.length==0){Ie=null,v.removeFeature(be);return}}else rt(j,Ie)==!0?(ye.push(A),oe.addFeature(new Re({geometry:new Ae(B),type:"neg",pixel:A}))):(fe.push(A),oe.addFeature(new Re({geometry:new Ae(B),type:"pos",pixel:A})));v.removeFeature(be)}else fe=[A],ye=[],oe.clear(),oe.addFeature(new Re({geometry:new Ae(B),type:"pos",pixel:A}));U.post("/api/Sam/GetMask",{PosPoints:fe,NegPoints:ye}).then(se=>{let ue=JSON.parse(se),H=JSON.parse(ue.masks).features[0].geometry;for(let X=0;X<H.coordinates.length;X++)for(let F=0;F<H.coordinates[X].length;F++)for(let Ce=0;Ce<H.coordinates[X][F].length;Ce++)H.coordinates[X][F][Ce][0]=H.coordinates[X][F][Ce][0]*ee+ce[0],H.coordinates[X][F][Ce][1]=ce[3]-H.coordinates[X][F][Ce][1]*ee;Ie=ca(H.coordinates),be=new Re({geometry:new nt().readGeometry(H)}),v.addFeature(be)})}else te("该区域没有初始化")},Ke=()=>{let E=o.getSize();ce=o.getView().calculateExtent(),Ve=pa(ce),U.post("api/Sam/SetImage",{LabelId:s.imageLabel.id,Extent:ce,Size:E}).then(()=>{Z.value=!0})};return(E,B)=>{const A=y("el-button"),Le=y("el-popover"),ee=y("el-icon"),j=y("el-radio-button"),Y=y("el-radio-group"),se=y("el-switch"),ue=y("el-option"),xe=y("el-select"),H=y("el-popconfirm"),X=y("el-slider");return I(),G("div",ja,[D("div",Ka,[D("div",Qa,[D("span",null,me(t.imageLabel.imageName),1),a(Le,{placement:"bottom-start",trigger:"hover",width:"240"},{reference:n(()=>[a(A,{type:"primary",icon:N(Ze),link:""},null,8,["icon"])]),default:n(()=>[a(ot,{image:t.imageLabel.image},null,8,["image"])]),_:1}),t.imageLabel.nextImage?(I(),G(ae,{key:0},[D("span",null,me(t.imageLabel.nextImageName),1),a(Le,{placement:"bottom-start",trigger:"hover",width:"240"},{reference:n(()=>[a(A,{type:"primary",icon:N(Ze),link:""},null,8,["icon"])]),default:n(()=>[a(ot,{image:t.imageLabel.nextImage},null,8,["image"])]),_:1})],64)):he("",!0)]),D("div",Ya,[a(Y,{modelValue:r.value,"onUpdate:modelValue":B[0]||(B[0]=F=>r.value=F),onChange:ie,style:{"margin-left":"16px"}},{default:n(()=>[a(j,{label:"view"},{default:n(()=>[a(ee,null,{default:n(()=>[a(N(kt))]),_:1}),L(" 浏览 ")]),_:1}),a(j,{label:"delete"},{default:n(()=>[a(ee,null,{default:n(()=>[a(N(Be))]),_:1}),L(" 删除 ")]),_:1}),a(j,{label:"draw"},{default:n(()=>[a(ee,null,{default:n(()=>[a(N(Tt))]),_:1}),L(" 标注 ")]),_:1})]),_:1},8,["modelValue"]),a(se,{modelValue:W.value,"onUpdate:modelValue":B[1]||(B[1]=F=>W.value=F),loading:!Z.value,"before-change":f,size:"large","inline-prompt":"","active-text":"智能标注","inactive-text":"智能标注"},null,8,["modelValue","loading"]),a(A,{type:"primary",onClick:N(k),plain:"",disabled:N(R).length==0},{default:n(()=>[Za,L(" 撤销删除")]),_:1},8,["onClick","disabled"]),S.value?he("",!0):(I(),K(xe,{key:0,modelValue:P.value,"onUpdate:modelValue":B[2]||(B[2]=F=>P.value=F),placeholder:"请选择",style:{width:"150px"}},{default:n(()=>[(I(!0),G(ae,null,ge(N(w),F=>(I(),K(ue,{key:F.id,label:F.name,value:F.id},{default:n(()=>[a(Xe,{name:F.name,color:F.color,style:{height:"100%"}},null,8,["name","color"])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])),a(_a,{onOnSuccess:g,style:{display:"inline-block"}},{default:n(()=>[a(A,null,{default:n(()=>[L("上传标注")]),_:1})]),_:1}),a(A,{type:"primary",onClick:we,plain:""},{default:n(()=>[el,L(" 保存")]),_:1}),a(H,{width:"190","confirm-button-text":"删除","cancel-button-text":"取消",title:"确认清空全部标签么？清空后不可撤销！",onConfirm:O},{reference:n(()=>[a(A,{type:"warning",icon:N(Be)},{default:n(()=>[L("清空")]),_:1},8,["icon"])]),_:1}),a(A,{type:"primary",icon:N(Vt),link:"",onClick:q,style:{"font-size":"20px"}},null,8,["icon"])])]),D("div",tl,[S.value?(I(),K(X,{key:0,class:"slider",modelValue:V.value,"onUpdate:modelValue":B[3]||(B[3]=F=>V.value=F),"show-tooltip":!1,onInput:z},null,8,["modelValue"])):he("",!0),a(da,{option:u.value},null,8,["option"])]),a(Ua,{ref_key:"tagRelateRef",ref:J,onComplate:M},null,512)])}}});const ll=St(al,[["__scopeId","data-v-1ea8947b"]]),ol={class:"flex-gap-8"},nl={key:0,class:"directory"},sl=D("img",{class:"directory_icon",src:Ut},null,-1),rl=["onClick"],il={key:1},dl={class:"directory"},ul=D("img",{class:"directory_icon",src:gt},null,-1),cl=["onClick"],pl={key:0,class:"directory",style:{"margin-top":"4px"}},ml=D("img",{class:"directory_icon",src:gt},null,-1),gl=["onClick"],fl={class:"flex-gap-8"},Tl=Me({__name:"Index",props:{datasetId:{type:String},datasetName:{type:String},datasetType:{type:String}},setup(t){const e=t,{taskTypeList:l,getTaskTypeName:d}=Gt();Et(()=>e.datasetId,()=>{R(),v()});const s=Se(()=>{let b=!1;if(e.datasetId==null&&h.value.length>1){const g=h.value[0];b=h.value.some(M=>M.type!=g.type)}return h.value.length==0||b}),r=Se(()=>e.datasetId?"新建目录":"新建数据集"),u=T(!1),o=T([]),v=()=>{e.datasetId==null?o.value=[]:U({method:"get",url:"api/dataset/GetDirectory",params:{id:e.datasetId}}).then(b=>{o.value=b})},_=T(!1),C=T();let w=T({id:void 0,name:"",type:"",desc:"",parentId:""});const Q=pt({name:[{required:!0,message:"请输入数据集名称",trigger:"blur"},{max:50,message:"数据集名称需少于 50 个字符",trigger:"blur"}],type:[{required:!0,message:"请选择数据集类型",trigger:"change"}]});mt(()=>{R(),v()});const $=Se(()=>w.value.id?"编辑":"新建"),x=b=>{Bt.push({path:"/dataset",query:{datasetId:b.id,datasetName:b.name,datasetType:b.type}})};let h=T([]);const p=b=>{h.value=b},i=()=>{let b=[],g=[];h.value.forEach(M=>{M.parentId?b.push(M.id):g.push(M.id)}),et.confirm("确认删除所选数据么?","提示",{showConfirmButton:!0,confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{U.post("api/Dataset/Delete",{DatasetIds:b,LabelIds:g}).then(()=>{R()})})},m=()=>{e.datasetId==null?_.value=!0:et.prompt("","新建目录",{confirmButtonText:"提交",cancelButtonText:"取消",inputPattern:/\S/,inputPlaceholder:"请输入目录名称",inputErrorMessage:"请输入目录名称",inputValidator:b=>{if(b.indexOf(" ")!=-1)return"名称中不可含有空格";let g=b.length;return g<1?"请输入文件夹名称":g>50?"文件名长度需少于 50 个字符":!0}}).then(({value:b})=>{U.post("/api/Dataset/Create",{name:b,type:e.datasetType,parentId:e.datasetId}).then(()=>{_.value=!1,R(),te({type:"success",message:"提交成功"})})})},c=T(""),k=T(),R=async()=>{let b=await U.get("api/Dataset/GetDatasets",{params:{datasetId:e.datasetId}}),g=await U.get("api/Label/GetLabelsInDataset",{params:{datasetId:e.datasetId}});k.value=[...b,...g]},P=()=>{var b;(b=C.value)==null||b.resetFields(),w.value.id=void 0},S=()=>{_.value=!0,Ot(()=>{w.value={...h.value[0]}})},V=()=>{var b;(b=C.value)==null||b.validate(g=>{if(g){let M=w.value.id?"Update":"Create";w.value.parentId=e.datasetId,U.post("/api/Dataset/"+M,w.value).then(()=>{_.value=!1,R(),te({type:"success",message:"提交成功"})})}})},re=()=>{R()},le=async(b,g)=>{let M;b.level!=0&&(M=b.data.id);let W=await U.get("api/Dataset/GetDatasets",{params:{type:e.datasetType!=null?e.datasetType:h.value[0].type,datasetId:M}});return W.forEach(Z=>{Z.picture="mac-folder-48.png"}),g(W)},z=T(),q=T(!1),ie=b=>{if(h.value.length>0){let g=[],M=[];h.value.forEach(W=>{W.imageName==null?g.push(W.id):M.push(W.id)}),U.post(`api/Label/${b}`,{DatasetIds:g,LabelIds:M,ParentId:z.value.getCheckedNodes()[0].id}).then(()=>{q.value=!1,R(),te({message:b=="copy"?"复制成功":"移动成功",type:"success"})})}},de=T(!1),we=T(),O=b=>{we.value=b,de.value=!0},J=()=>{de.value=!1,R()};return(b,g)=>{const M=y("el-button"),W=y("el-button-group"),Z=y("el-input"),ke=y("el-divider"),_e=y("el-breadcrumb-item"),oe=y("el-breadcrumb"),ne=y("el-table-column"),Ie=y("el-table"),ce=y("el-form-item"),Ve=y("el-option"),fe=y("el-select"),ye=y("el-form"),be=y("el-dialog");return I(),G(ae,null,[a(zt,{title:"影像标注",icon:"icon-fuhaoku"}),D("div",ol,[a(M,{type:"primary",icon:N(Ft),onClick:m},{default:n(()=>[L(me(r.value),1)]),_:1},8,["icon"]),a(M,{type:"primary",icon:N(Mt),disabled:t.datasetId==null,onClick:g[0]||(g[0]=f=>u.value=!0)},{default:n(()=>[L("添加影像")]),_:1},8,["icon","disabled"]),a(W,null,{default:n(()=>[a(M,{type:"primary",icon:N(Nt),onClick:S,plain:"",disabled:N(h).length!=1},{default:n(()=>[L("编辑")]),_:1},8,["icon","disabled"]),a(M,{type:"primary",icon:N($t),onClick:g[1]||(g[1]=f=>q.value=!0),plain:"",disabled:s.value},{default:n(()=>[L("移动/复制")]),_:1},8,["icon","disabled"]),a(M,{type:"primary",icon:N(Be),plain:"",onClick:i,disabled:N(h).length==0},{default:n(()=>[L("删除")]),_:1},8,["icon","disabled"])]),_:1}),a(Z,{modelValue:c.value,"onUpdate:modelValue":g[2]||(g[2]=f=>c.value=f),modelModifiers:{trim:!0},style:{width:"300px"},placeholder:"搜索您的数据",clearable:""},null,8,["modelValue"])]),a(ke),a(oe,{"separator-class":"el-icon-arrow-right"},{default:n(()=>[a(_e,{to:{path:"/dataset"}},{default:n(()=>[L("我的数据")]),_:1}),(I(!0),G(ae,null,ge(o.value,f=>(I(),K(_e,{key:f.id,to:{path:"/dataset",query:{datasetId:f.id,datasetName:f.name,datasetType:f.type}}},{default:n(()=>[L(me(f.name),1)]),_:2},1032,["to"]))),128))]),_:1}),a(Ie,{data:k.value,style:{"margin-top":"16px"},height:"calc(100vh - 270px)",onSelectionChange:p},{default:n(()=>[a(ne,{type:"selection"}),a(ne,{label:"数据集"},{default:n(f=>[f.row.parentId?(I(),G("div",nl,[sl,D("span",{class:"directory_name",onClick:pe=>x(f.row)},me(f.row.name),9,rl)])):(I(),G("div",il,[D("div",dl,[ul,D("span",{class:"directory_name",onClick:pe=>O(f.row)},me(f.row.imageName),9,cl)]),f.row.nextImageName?(I(),G("div",pl,[ml,D("span",{class:"directory_name",onClick:pe=>O(f.row)},me(f.row.nextImageName),9,gl)])):he("",!0)]))]),_:1}),a(ne,{prop:"type",label:"类型"},{default:n(f=>[L(me(N(d)(f.row.type)),1)]),_:1}),a(ne,{prop:"labelTypes",label:"标签","show-overflow-tooltip":""},{default:n(f=>[D("div",fl,[(I(!0),G(ae,null,ge(f.row.tags,pe=>(I(),K(Xe,{key:pe.id,name:pe.name,color:pe.color},null,8,["name","color"]))),128))])]),_:1}),a(ne,{prop:"labelCount",label:"标注数",width:"120"}),a(ne,{prop:"imageCount",label:"样本数"}),a(ne,{prop:"updated",label:"更新日期",sortable:"",width:"150"})]),_:1},8,["data"]),a(be,{title:$.value,modelValue:_.value,"onUpdate:modelValue":g[7]||(g[7]=f=>_.value=f),"close-on-click-modal":!1,width:"500px",onClosed:P},{footer:n(()=>[a(M,{onClick:g[6]||(g[6]=f=>_.value=!1)},{default:n(()=>[L("取消")]),_:1}),a(M,{type:"primary",onClick:V},{default:n(()=>[L("提交")]),_:1})]),default:n(()=>[a(ye,{model:N(w),rules:Q,ref_key:"formRef",ref:C,"label-position":"top"},{default:n(()=>[a(ce,{label:"数据集名称",prop:"name"},{default:n(()=>[a(Z,{modelValue:N(w).name,"onUpdate:modelValue":g[3]||(g[3]=f=>N(w).name=f),modelModifiers:{trim:!0}},null,8,["modelValue"])]),_:1}),a(ce,{label:"数据集类型",prop:"type"},{default:n(()=>[a(fe,{placeholder:"请选择类型",modelValue:N(w).type,"onUpdate:modelValue":g[4]||(g[4]=f=>N(w).type=f),style:{width:"100%"},disabled:N(w).id!=null},{default:n(()=>[(I(!0),G(ae,null,ge(N(l),f=>(I(),K(Ve,{key:f.name,label:f.title,value:f.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),a(ce,{label:"描述",prop:"desc"},{default:n(()=>[a(Z,{type:"textarea",placeholder:"请输入数据集描述",modelValue:N(w).desc,"onUpdate:modelValue":g[5]||(g[5]=f=>N(w).desc=f),maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"]),a(be,{title:"选择数据集",modelValue:q.value,"onUpdate:modelValue":g[11]||(g[11]=f=>q.value=f),"close-on-click-modal":!1,width:"500px"},{footer:n(()=>[a(M,{onClick:g[8]||(g[8]=f=>q.value=!1)},{default:n(()=>[L("取消")]),_:1}),a(M,{type:"primary",disabled:"",onClick:g[9]||(g[9]=f=>ie("copy"))},{default:n(()=>[L("复制")]),_:1}),a(M,{type:"primary",onClick:g[10]||(g[10]=f=>ie("Move"))},{default:n(()=>[L("移动")]),_:1})]),default:n(()=>[q.value?(I(),K(ft,{key:0,ref_key:"datesetTreeSelectRef",ref:z,"load-node":le},null,512)):he("",!0)]),_:1},8,["modelValue"]),a(Na,{modelValue:u.value,"onUpdate:modelValue":g[12]||(g[12]=f=>u.value=f),"dataset-id":t.datasetId,pair:t.datasetType=="change",onSuccess:re},null,8,["modelValue","dataset-id","pair"]),(I(),K(Dt,null,{default:n(()=>[a(At,{name:"el-fade-in-linear"},{default:n(()=>[de.value?(I(),K(ll,{key:0,imageLabel:we.value,onClose:J},null,8,["imageLabel"])):he("",!0)]),_:1})]),_:1}))],64)}}});export{Tl as default};
