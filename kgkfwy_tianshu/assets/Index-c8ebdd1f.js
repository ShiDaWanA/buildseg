import{_ as ze}from"./picture-48-70f98f1e.js";import{r as bt,u as Me,w as Kt}from"./xlsx-4f9172c7.js";import{d as Fe,u as Qt,r as P,a as Qe,M as eo,c as w,o as H,m as ve,w as u,e as oe,f as k,t as ue,h as a,g as S,N as lt,F as xe,z as me,i as M,aa as to,ab as oo,ac as no,ad as ao,O as De,q as Se,s as ro,J as he,K as _e,T as je,l as Q,a5 as et,p as wt,n as Tt,_ as kt,a2 as lo,ae as Ge,L as It,af as io,a6 as so,E as ce,P as $e,ag as uo,ah as Ct,ai as co,S as po,D as Ue,H as fo,I as mo,a9 as ho,aj as _o,ak as go,a4 as yo,al as vo}from"./index-ab68adb5.js";import{B as xo}from"./BaseTitle-588acb84.js";import{ab as bo,y as ke,F as qe,ac as it,ad as He,a8 as wo,ae as To,P as ko,af as Io,ag as Co,ah as Po,M as Pt,V as Lt,d as Mt,_ as st,a as Lo,a7 as Be,S as Ce,v as Pe,p as Je,r as Ze,u as St,a3 as Mo,ai as Ae,aj as Et,ak as So,al as ut,a6 as Eo,am as Ro,aa as ct}from"./ImageInfo.vue_vue_type_script_setup_true_lang-abee9b6f.js";import{u as No,V as Fo,a as be,_ as Rt,M as Oo,S as Vo,f as Ee,d as Re,e as Bo,h as dt,i as tt,b as Ne}from"./useTag-af0a58db.js";import{_ as Nt,C as Go,an as $o,O as pt,ac as ft,bc as mt,q as ht,a8 as Ao,$ as Yo,e as zo,u as Xo,S as Uo,a as Do,i as jo}from"./index.esm.min-90f1887f.js";import{C as qo}from"./index-f53ede3a.js";import{c as Ye,a as Ho}from"./map-6df5e062.js";import{i as Jo}from"./install-def00ef4.js";import{_ as Ft}from"./folder-upload-48-6c4e3231.js";import{B as Zo,u as Wo,T as Oe}from"./useSetting-1e631b4e.js";/* empty css           */import{T as Ko}from"./TaskProgress-8f20ffc2.js";import{H as Qo}from"./HubConnectionBuilder-04baf802.js";import"./format-aee67674.js";var en=function(l){Nt(e,l);function e(){var t=l!==null&&l.apply(this,arguments)||this;return t.type=e.type,t.layoutMode={type:"box",ignoreSize:!0},t}return e.type="title",e.defaultOption={z:6,show:!0,text:"",target:"blank",subtext:"",subtarget:"blank",left:0,top:0,backgroundColor:"rgba(0,0,0,0)",borderColor:"#ccc",borderWidth:0,padding:5,itemGap:10,textStyle:{fontSize:18,fontWeight:"bold",color:"#464646"},subtextStyle:{fontSize:12,color:"#6E7079"}},e}(Go),tn=function(l){Nt(e,l);function e(){var t=l!==null&&l.apply(this,arguments)||this;return t.type=e.type,t}return e.prototype.render=function(t,r,i){if(this.group.removeAll(),!!t.get("show")){var s=this.group,I=t.getModel("textStyle"),E=t.getModel("subtextStyle"),R=t.get("textAlign"),T=$o(t.get("textBaseline"),t.get("textVerticalAlign")),K=new pt({style:ft(I,{text:t.get("text"),fill:I.getTextColor()},{disableBox:!0}),z2:10}),ee=K.getBoundingRect(),J=t.get("subtext"),Y=new pt({style:ft(E,{text:J,fill:E.getTextColor(),y:ee.height+t.get("itemGap"),verticalAlign:"top"},{disableBox:!0}),z2:10}),$=t.get("link"),N=t.get("sublink"),F=t.get("triggerEvent",!0);K.silent=!$&&!F,Y.silent=!N&&!F,$&&K.on("click",function(){mt($,"_"+t.get("target"))}),N&&Y.on("click",function(){mt(N,"_"+t.get("subtarget"))}),ht(K).eventData=ht(Y).eventData=F?{componentType:"title",componentIndex:t.componentIndex}:null,s.add(K),J&&s.add(Y);var z=s.getBoundingRect(),n=t.getBoxLayoutParams();n.width=z.width,n.height=z.height;var o=Ao(n,{width:i.getWidth(),height:i.getHeight()},t.get("padding"));R||(R=t.get("left")||t.get("right"),R==="middle"&&(R="center"),R==="right"?o.x+=o.width:R==="center"&&(o.x+=o.width/2)),T||(T=t.get("top")||t.get("bottom"),T==="center"&&(T="middle"),T==="bottom"?o.y+=o.height:T==="middle"&&(o.y+=o.height/2),T=T||"top"),s.x=o.x,s.y=o.y,s.markRedraw();var d={align:R,verticalAlign:T};K.setStyle(d),Y.setStyle(d),z=s.getBoundingRect();var m=o.margin,_=t.getItemStyle(["color","opacity"]);_.fill=t.get("backgroundColor");var h=new Yo({shape:{x:z.x-m[3],y:z.y-m[0],width:z.width+m[1]+m[3],height:z.height+m[0]+m[2],r:t.get("borderRadius")},style:_,subPixelOptimize:!0,silent:!0});s.add(h)}},e.type="title",e}(zo);function on(l){l.registerComponentModel(en),l.registerComponentView(tn)}class nn extends bo{constructor(){super()}getType(){return"text"}readFeature(e,t){return this.readFeatureFromText(Ve(e),this.adaptOptions(t))}readFeatureFromText(e,t){return ke()}readFeatures(e,t){return this.readFeaturesFromText(Ve(e),this.adaptOptions(t))}readFeaturesFromText(e,t){return ke()}readGeometry(e,t){return this.readGeometryFromText(Ve(e),this.adaptOptions(t))}readGeometryFromText(e,t){return ke()}readProjection(e){return this.readProjectionFromText(Ve(e))}readProjectionFromText(e){return this.dataProjection}writeFeature(e,t){return this.writeFeatureText(e,this.adaptOptions(t))}writeFeatureText(e,t){return ke()}writeFeatures(e,t){return this.writeFeaturesText(e,this.adaptOptions(t))}writeFeaturesText(e,t){return ke()}writeGeometry(e,t){return this.writeGeometryText(e,this.adaptOptions(t))}writeGeometryText(e,t){return ke()}}function Ve(l){return typeof l=="string"?l:""}const an=nn,rn={POINT:wo,LINESTRING:To,POLYGON:ko,MULTIPOINT:Io,MULTILINESTRING:Co,MULTIPOLYGON:Po},Ot="EMPTY",Vt="Z",Bt="M",ln="ZM",U={START:0,TEXT:1,LEFT_PAREN:2,RIGHT_PAREN:3,NUMBER:4,COMMA:5,EOF:6},sn={Point:"POINT",LineString:"LINESTRING",Polygon:"POLYGON",MultiPoint:"MULTIPOINT",MultiLineString:"MULTILINESTRING",MultiPolygon:"MULTIPOLYGON",GeometryCollection:"GEOMETRYCOLLECTION",Circle:"CIRCLE"};class un{constructor(e){this.wkt=e,this.index_=-1}isAlpha_(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}isNumeric_(e,t){return t=t!==void 0?t:!1,e>="0"&&e<="9"||e=="."&&!t}isWhiteSpace_(e){return e==" "||e=="	"||e=="\r"||e==`
`}nextChar_(){return this.wkt.charAt(++this.index_)}nextToken(){const e=this.nextChar_(),t=this.index_;let r=e,i;if(e=="(")i=U.LEFT_PAREN;else if(e==",")i=U.COMMA;else if(e==")")i=U.RIGHT_PAREN;else if(this.isNumeric_(e)||e=="-")i=U.NUMBER,r=this.readNumber_();else if(this.isAlpha_(e))i=U.TEXT,r=this.readText_();else{if(this.isWhiteSpace_(e))return this.nextToken();if(e==="")i=U.EOF;else throw new Error("Unexpected character: "+e)}return{position:t,value:r,type:i}}readNumber_(){let e;const t=this.index_;let r=!1,i=!1;do e=="."?r=!0:(e=="e"||e=="E")&&(i=!0),e=this.nextChar_();while(this.isNumeric_(e,r)||!i&&(e=="e"||e=="E")||i&&(e=="-"||e=="+"));return parseFloat(this.wkt.substring(t,this.index_--))}readText_(){let e;const t=this.index_;do e=this.nextChar_();while(this.isAlpha_(e));return this.wkt.substring(t,this.index_--).toUpperCase()}}class cn{constructor(e){this.lexer_=e,this.token_={position:0,type:U.START},this.layout_="XY"}consume_(){this.token_=this.lexer_.nextToken()}isTokenType(e){return this.token_.type==e}match(e){const t=this.isTokenType(e);return t&&this.consume_(),t}parse(){return this.consume_(),this.parseGeometry_()}parseGeometryLayout_(){let e="XY";const t=this.token_;if(this.isTokenType(U.TEXT)){const r=t.value;r===Vt?e="XYZ":r===Bt?e="XYM":r===ln&&(e="XYZM"),e!=="XY"&&this.consume_()}return e}parseGeometryCollectionText_(){if(this.match(U.LEFT_PAREN)){const e=[];do e.push(this.parseGeometry_());while(this.match(U.COMMA));if(this.match(U.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parsePointText_(){if(this.match(U.LEFT_PAREN)){const e=this.parsePoint_();if(this.match(U.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseLineStringText_(){if(this.match(U.LEFT_PAREN)){const e=this.parsePointList_();if(this.match(U.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parsePolygonText_(){if(this.match(U.LEFT_PAREN)){const e=this.parseLineStringTextList_();if(this.match(U.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseMultiPointText_(){if(this.match(U.LEFT_PAREN)){let e;if(this.token_.type==U.LEFT_PAREN?e=this.parsePointTextList_():e=this.parsePointList_(),this.match(U.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseMultiLineStringText_(){if(this.match(U.LEFT_PAREN)){const e=this.parseLineStringTextList_();if(this.match(U.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseMultiPolygonText_(){if(this.match(U.LEFT_PAREN)){const e=this.parsePolygonTextList_();if(this.match(U.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parsePoint_(){const e=[],t=this.layout_.length;for(let r=0;r<t;++r){const i=this.token_;if(this.match(U.NUMBER))e.push(i.value);else break}if(e.length==t)return e;throw new Error(this.formatErrorMessage_())}parsePointList_(){const e=[this.parsePoint_()];for(;this.match(U.COMMA);)e.push(this.parsePoint_());return e}parsePointTextList_(){const e=[this.parsePointText_()];for(;this.match(U.COMMA);)e.push(this.parsePointText_());return e}parseLineStringTextList_(){const e=[this.parseLineStringText_()];for(;this.match(U.COMMA);)e.push(this.parseLineStringText_());return e}parsePolygonTextList_(){const e=[this.parsePolygonText_()];for(;this.match(U.COMMA);)e.push(this.parsePolygonText_());return e}isEmptyGeometry_(){const e=this.isTokenType(U.TEXT)&&this.token_.value==Ot;return e&&this.consume_(),e}formatErrorMessage_(){return"Unexpected `"+this.token_.value+"` at position "+this.token_.position+" in `"+this.lexer_.wkt+"`"}parseGeometry_(){const e=this.token_;if(this.match(U.TEXT)){const t=e.value;this.layout_=this.parseGeometryLayout_();const r=this.isEmptyGeometry_();if(t=="GEOMETRYCOLLECTION"){if(r)return new He([]);const I=this.parseGeometryCollectionText_();return new He(I)}const i=rn[t];if(!i)throw new Error("Invalid geometry type: "+t);let s;if(r)t=="POINT"?s=[NaN,NaN]:s=[];else switch(t){case"POINT":{s=this.parsePointText_();break}case"LINESTRING":{s=this.parseLineStringText_();break}case"POLYGON":{s=this.parsePolygonText_();break}case"MULTIPOINT":{s=this.parseMultiPointText_();break}case"MULTILINESTRING":{s=this.parseMultiLineStringText_();break}case"MULTIPOLYGON":{s=this.parseMultiPolygonText_();break}}return new i(s,this.layout_)}throw new Error(this.formatErrorMessage_())}}class dn extends an{constructor(e){super(),e=e||{},this.splitCollection_=e.splitCollection!==void 0?e.splitCollection:!1}parse_(e){const t=new un(e);return new cn(t).parse()}readFeatureFromText(e,t){const r=this.readGeometryFromText(e,t),i=new qe;return i.setGeometry(r),i}readFeaturesFromText(e,t){let r=[];const i=this.readGeometryFromText(e,t);this.splitCollection_&&i.getType()=="GeometryCollection"?r=i.getGeometriesArray():r=[i];const s=[];for(let I=0,E=r.length;I<E;++I){const R=new qe;R.setGeometry(r[I]),s.push(R)}return s}readGeometryFromText(e,t){const r=this.parse_(e);return it(r,!1,t)}writeFeatureText(e,t){const r=e.getGeometry();return r?this.writeGeometryText(r,t):""}writeFeaturesText(e,t){if(e.length==1)return this.writeFeatureText(e[0],t);const r=[];for(let s=0,I=e.length;s<I;++s)r.push(e[s].getGeometry());const i=new He(r);return this.writeGeometryText(i,t)}writeGeometryText(e,t){return At(it(e,!0,t))}}function Gt(l){const e=l.getCoordinates();return e.length===0?"":e.join(" ")}function pn(l){const e=[],t=l.getPoints();for(let r=0,i=t.length;r<i;++r)e.push("("+Gt(t[r])+")");return e.join(",")}function fn(l){const e=[],t=l.getGeometries();for(let r=0,i=t.length;r<i;++r)e.push(At(t[r]));return e.join(",")}function ot(l){const e=l.getCoordinates(),t=[];for(let r=0,i=e.length;r<i;++r)t.push(e[r].join(" "));return t.join(",")}function mn(l){const e=[],t=l.getLineStrings();for(let r=0,i=t.length;r<i;++r)e.push("("+ot(t[r])+")");return e.join(",")}function $t(l){const e=[],t=l.getLinearRings();for(let r=0,i=t.length;r<i;++r)e.push("("+ot(t[r])+")");return e.join(",")}function hn(l){const e=[],t=l.getPolygons();for(let r=0,i=t.length;r<i;++r)e.push("("+$t(t[r])+")");return e.join(",")}function _n(l){const e=l.getLayout();let t="";return(e==="XYZ"||e==="XYZM")&&(t+=Vt),(e==="XYM"||e==="XYZM")&&(t+=Bt),t}const gn={Point:Gt,LineString:ot,Polygon:$t,MultiPoint:pn,MultiLineString:mn,MultiPolygon:hn,GeometryCollection:fn};function At(l){const e=l.getType(),t=gn[e],r=t(l);let i=sn[e];if(typeof l.getFlatCoordinates=="function"){const s=_n(l);s.length>0&&(i+=" "+s)}return r.length===0?i+" "+Ot:i+"("+r+")"}const yn=dn,Xe=l=>(wt("data-v-ba4170ce"),l=l(),Tt(),l),vn={key:0,class:"map-dialog"},xn={class:"map-dialog-header"},bn={class:"map-dialog-title"},wn={class:"flex-gap-8",style:{"align-items":"center"}},Tn=Xe(()=>k("span",{style:{"margin-right":"4px",color:"#ffffff","font-size":"14px"}},"透明度",-1)),kn={id:"map",class:"map"},In={key:1,id:"legend"},Cn={id:"chart"},Pn={id:"regularization",class:"app-panel__wrapper"},Ln={class:"app-panel__header"},Mn=Xe(()=>k("span",null,"图形规则化",-1)),Sn={style:{padding:"16px"}},En=Xe(()=>k("span",{style:{"font-size":"14px","padding-right":"10px"}},"线宽",-1)),Rn={style:{display:"flex","align-items":"center"}},Nn=Xe(()=>k("span",{style:{"font-size":"14px","padding-right":"10px"}},"颜色",-1)),Fn={slot:"footer",style:{"margin-top":"16px"}},On=Fe({__name:"InferResult",setup(l,{expose:e}){Xo([on,Do,Jo,jo]);const t=Qt(),r=P(),i=P();let s=P({generlizeOffset:.2,minLength:30,maxAngle:80,maxOffset:50});const I=Qe({generlizeOffset:[{required:!0,message:"最大偏移量",trigger:"change"},{type:"number",min:0,message:"请输入大于0的数"}],minLength:[{required:!0,message:"最短距离",trigger:"change"},{type:"number",min:0,message:"请输入大于0的数"}],maxAngle:[{required:!0,message:"最大角度",trigger:"change"},{type:"number",min:0,message:"请输入大于0的数"}],maxOffset:[{required:!0,message:"最大偏移量",trigger:"change"},{type:"number",min:0,message:"请输入大于0的数"}]}),E=()=>{var j;(j=i.value)==null||j.validate(L=>{L&&Q.post("api/Infer/ShapeRegularization",{...s.value,id:o.value.id}).then(B=>{N.clear(),N.addFeatures(new Be().readFeatures(B))})})},R=()=>{Q({method:"POST",url:"api/Infer/GetRegularizationfile/"+o.value.id,responseType:"blob"}).then(j=>{const L=j.data,B=new Blob([L]),Z=document.createElement("a");Z.download=o.value.image.name+".zip",Z.target="_blank",Z.style.display="none",Z.href=URL.createObjectURL(B),document.body.appendChild(Z),Z.click(),URL.revokeObjectURL(Z.href),document.body.removeChild(Z)})};let T=new Pt({view:new Lt({projection:"EPSG:3857"}),controls:Mt({attribution:!1,rotate:!1,zoom:!1})});eo("map",T);const K=P([]),ee=P([]),J=P({});let Y=null,$,N,F;const z=P(50),n=P(50),o=P({}),d=[{value:.1,label:"高召回"},{value:.2,label:"较高召回"},{value:.3,label:"均衡"},{value:.4,label:"较高准确"},{value:.5,label:"高准确"}],m=j=>d.find(B=>B.value==j).label,_=P(!1),h=P(!1),v=()=>{T.setTarget(void 0),T.setLayers([]),D.value=0,_.value=!1,h.value=!1},f=P(!0),c=j=>{Y.setVisible(j)},p=P("#409EFF"),y=j=>{F.setStyle(()=>new Ce({stroke:new Pe({color:p.value,width:j})}))},g=P(1),O=j=>{F.setStyle(()=>new Ce({stroke:new Pe({color:j,width:g.value})}))},G=P(!0),te=()=>{N.clear(),Y.setVisible(!0),f.value=!0,G.value=!0,h.value=!1},X=j=>{switch(j){case"raster":A("GetRaster");break}},b=j=>{switch(j){case"addToDataset":break;case"regularization":h.value=!0;break}},C=j=>{let L="#F56C6C";if(o.value.nextImage==null){let B=j.get("TagId");L=o.value.tags.find(V=>V.id===B).color}return new Ce({fill:new St({color:qo(L).alpha(n.value/100).toString()}),stroke:new Pe({color:L,width:2})})},x=()=>{Y&&Y.setStyle(C)},A=j=>{Q({method:"POST",url:`api/Infer/${j}/${o.value.id}`,responseType:"blob"}).then(L=>{const B=L.data,Z=new Blob([B]);let V=L.headers["content-disposition"],ae=new RegExp("filename=([^;]+\\.[^\\.;]+);*").exec(V),re=decodeURI(ae[1]);const ne=document.createElement("a");ne.download=re,ne.target="_blank",ne.style.display="none",ne.href=URL.createObjectURL(Z),document.body.appendChild(ne),ne.click(),URL.revokeObjectURL(ne.href),document.body.removeChild(ne)})},D=P(0);e({show:j=>{o.value=j,_.value=!0,No(T,o.value.tags),et(()=>{le(o.value.image.resolution),Q.get("api/Infer/GetStatisticsInfo/"+o.value.id).then(L=>{L.length>1?(D.value=L.reduce((B,Z)=>(B=B.number?B.number:B,B+Z.number)),L.forEach(B=>{let Z=o.value.tags.find(V=>V.name===B.tagName);ee.value.push({name:B.tagName,value:B.labelCount,itemStyle:{color:Z.color}}),K.value.push({name:B.tagName,value:B.labelArea.toFixed(2),itemStyle:{color:Z.color}})}),J.value={title:[{subtext:"数量统计",top:"0%",left:"50%",textAlign:"center"},{subtext:"面积统计",top:"50%",left:"50%",textAlign:"center"}],tooltip:{appendToBody:!0,trigger:"item"},series:[{type:"pie",radius:"35%",center:["50%","25%"],data:ee},{type:"pie",radius:"35%",center:["50%","75%"],data:K}]}):D.value=L[0].labelCount})})}});const le=j=>{T.setTarget("map");let L=Ye(o.value.image.layerName,o.value.image.boundingBox,j);T.addLayer(L),$=Ho(o.value.id),Y=new Fo({source:$,extent:o.value.boundingBox,style:C}),T.addLayer(Y),N=new Je,F=new Ze({source:N,style:()=>new Ce({stroke:new Pe({color:p.value,width:g.value})})}),T.addLayer(F);let B=new Je,Z=new Ze({source:B,style:()=>new Ce({stroke:new Pe({color:"#ff0000",lineDash:[7],width:3})})});if(T.addLayer(Z),T.getView().fit(o.value.image.boundingBox),o.value.nextImage){let ie=Ye(o.value.nextImage.layerName,o.value.nextImage.boundingBox,j);T.getLayers().insertAt(1,ie),ie.on("prerender",ae=>{var re=ae.context,ne=T.getSize(),ge=ne[0]*(z.value/100),we=be(ae,[ge,0]),se=be(ae,[ne[0],0]),pe=be(ae,[ge,ne[1]]),ye=be(ae,ne);re.save(),re.beginPath(),re.moveTo(we[0],we[1]),re.lineTo(pe[0],pe[1]),re.lineTo(ye[0],ye[1]),re.lineTo(se[0],se[1]),re.closePath(),re.clip()}),ie.on("postrender",ae=>{var re=ae.context;re.restore()})}o.value.boundary&&B.addFeature(new qe({geometry:new yn().readGeometry(o.value.boundary),name:"Boundary"}))},Le=()=>{T.render()};return(j,L)=>{const B=w("el-button"),Z=w("el-popover"),V=w("el-slider"),ie=w("el-icon"),ae=w("el-dropdown-item"),re=w("el-dropdown-menu"),ne=w("el-dropdown"),ge=w("el-descriptions-item"),we=w("el-descriptions"),se=w("el-divider"),pe=w("el-input-number"),ye=w("el-form-item"),q=w("el-col"),Te=w("el-row"),Ht=w("el-checkbox"),Jt=w("el-color-picker"),Zt=w("el-form");return H(),ve(je,{name:"el-fade-in-linear"},{default:u(()=>[_.value?(H(),oe("div",vn,[k("div",xn,[k("div",bn,[k("span",null,ue(o.value.imageName),1),a(Z,{placement:"bottom-start",trigger:"hover",width:"240"},{reference:u(()=>[a(B,{type:"primary",icon:S(lt),link:""},null,8,["icon"])]),default:u(()=>[a(st,{image:o.value.image},null,8,["image"])]),_:1}),o.value.nextImage?(H(),oe(xe,{key:0},[k("span",null,ue(o.value.nextImageName),1),a(Z,{placement:"bottom-start",trigger:"hover",width:"240"},{reference:u(()=>[a(B,{type:"primary",icon:S(lt),link:""},null,8,["icon"])]),default:u(()=>[a(st,{image:o.value.nextImage},null,8,["image"])]),_:1})],64)):me("",!0)]),k("div",wn,[Tn,a(V,{style:{width:"200px"},modelValue:n.value,"onUpdate:modelValue":L[0]||(L[0]=W=>n.value=W),"show-tooltip":!1,onInput:x},null,8,["modelValue"]),a(ne,{"split-button":"",type:"primary",onCommand:X,onClick:L[1]||(L[1]=W=>A("GetShapefile"))},{dropdown:u(()=>[a(re,null,{default:u(()=>{var W;return[a(ae,{command:"raster",disabled:!((W=S(t).setting)!=null&&W.inferGenerateRaster)},{default:u(()=>[M("下载栅格")]),_:1},8,["disabled"])]}),_:1})]),default:u(()=>[a(ie,{class:"el-icon--left"},{default:u(()=>[a(S(to))]),_:1}),M(" 下载矢量 ")]),_:1}),a(ne,{onCommand:b},{dropdown:u(()=>[a(re,null,{default:u(()=>[a(ae,{icon:S(oo),command:"regularization"},{default:u(()=>[M("图形规则化")]),_:1},8,["icon"]),a(ae,{icon:S(no),command:"addToDataset"},{default:u(()=>[M("添加到数据集")]),_:1},8,["icon"])]),_:1})]),default:u(()=>[a(B,{type:"primary",plain:""},{default:u(()=>[M("更多 "),a(ie,{class:"el-icon--right"},{default:u(()=>[a(S(ao))]),_:1})]),_:1})]),_:1}),a(B,{type:"primary",icon:S(De),link:"",onClick:v,style:{"font-size":"20px"}},null,8,["icon"])])]),k("div",kn,[o.value.nextImage?(H(),ve(V,{key:0,id:"slider",modelValue:z.value,"onUpdate:modelValue":L[2]||(L[2]=W=>z.value=W),"show-tooltip":!1,onInput:Le},null,8,["modelValue"])):me("",!0),a(Lo,{option:r.value},null,8,["option"]),o.value.nextImage==null?(H(),oe("div",In,[k("ul",null,[(H(!0),oe(xe,null,Se(o.value.tags,(W,Wt)=>(H(),oe("li",{key:Wt},[k("span",{style:ro({backgroundColor:W.color})},null,4),M(ue(W.name),1)]))),128))])])):me("",!0),k("div",Cn,[a(we,{column:1,border:""},{default:u(()=>[a(ge,{label:"图斑个数"},{default:u(()=>[M(ue(D.value),1)]),_:1}),a(ge,{label:"过滤阈值"},{default:u(()=>[M(ue(o.value.filterPixels)+"像素",1)]),_:1}),o.value.nextImage?(H(),ve(ge,{key:0,label:"置信度"},{default:u(()=>[M(ue(m(o.value.threshold)),1)]),_:1})):me("",!0)]),_:1}),he(a(S(Uo),{class:"chart",option:J.value,autoresize:""},null,8,["option"]),[[_e,o.value.tags.length>1]])])]),a(je,{name:"el-fade-in-linear"},{default:u(()=>[he(k("div",Pn,[k("div",Ln,[Mn,a(B,{link:"",icon:S(De),onClick:te},null,8,["icon"])]),k("div",Sn,[a(Zt,{model:S(s),rules:I,ref_key:"regularizationFormRef",ref:i,"label-position":"top"},{default:u(()=>[a(se,{"content-position":"left"},{default:u(()=>[M("抽稀参数")]),_:1}),a(ye,{label:"最大偏移量",prop:"generlizeOffset"},{default:u(()=>[a(pe,{modelValue:S(s).generlizeOffset,"onUpdate:modelValue":L[3]||(L[3]=W=>S(s).generlizeOffset=W),modelModifiers:{number:!0},step:1,min:0},null,8,["modelValue"])]),_:1}),a(se,{"content-position":"left"},{default:u(()=>[M("规则化参数")]),_:1}),a(Te,{gutter:16},{default:u(()=>[a(q,{span:8},{default:u(()=>[a(ye,{label:"最短距离",prop:"minLength"},{default:u(()=>[a(pe,{modelValue:S(s).minLength,"onUpdate:modelValue":L[4]||(L[4]=W=>S(s).minLength=W),modelModifiers:{number:!0},step:1,min:0},null,8,["modelValue"])]),_:1})]),_:1}),a(q,{span:8},{default:u(()=>[a(ye,{label:"最大角度",prop:"maxAngle"},{default:u(()=>[a(pe,{modelValue:S(s).maxAngle,"onUpdate:modelValue":L[5]||(L[5]=W=>S(s).maxAngle=W),modelModifiers:{number:!0},step:1,min:0},null,8,["modelValue"])]),_:1})]),_:1}),a(q,{span:8},{default:u(()=>[a(ye,{label:"最大偏移量",prop:"maxOffset"},{default:u(()=>[a(pe,{modelValue:S(s).maxOffset,"onUpdate:modelValue":L[6]||(L[6]=W=>S(s).maxOffset=W),modelModifiers:{number:!0},step:1,min:0},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(se,{"content-position":"left"},{default:u(()=>[M("图形样式")]),_:1}),a(Te,{gutter:16},{default:u(()=>[a(q,{span:8},{default:u(()=>[a(Ht,{modelValue:f.value,"onUpdate:modelValue":L[7]||(L[7]=W=>f.value=W),onChange:c},{default:u(()=>[M("原图")]),_:1},8,["modelValue"])]),_:1}),a(q,{span:8},{default:u(()=>[En,a(pe,{modelValue:g.value,"onUpdate:modelValue":L[8]||(L[8]=W=>g.value=W),"controls-position":"right",onChange:y,min:1,max:10,label:"线宽",style:{width:"80px"}},null,8,["modelValue"])]),_:1}),a(q,{span:8},{default:u(()=>[k("div",Rn,[Nn,a(Jt,{modelValue:p.value,"onUpdate:modelValue":L[9]||(L[9]=W=>p.value=W),onChange:O},null,8,["modelValue"])])]),_:1})]),_:1})]),_:1},8,["model","rules"]),k("div",Fn,[a(B,{type:"success",onClick:R},{default:u(()=>[M("下载")]),_:1}),a(B,{type:"primary",onClick:L[10]||(L[10]=W=>E())},{default:u(()=>[M("提交")]),_:1})])])],512),[[_e,h.value]])]),_:1})])):me("",!0)]),_:1})}}});const Vn=kt(On,[["__scopeId","data-v-ba4170ce"]]),Bn=l=>(wt("data-v-ac58c055"),l=l(),Tt(),l),Gn={key:0,class:"map-dialog",style:{"z-index":"3000"}},$n={class:"map-dialog-header"},An=Bn(()=>k("div",{class:"map-dialog-title"},[k("span",null,"解译范围设置")],-1)),Yn={class:"flex-gap-8"},zn={id:"map",class:"map"},Xn=Fe({__name:"DrawPolygon",setup(l,{expose:e}){const t=P(!1),r=P(50),i=P(!1);let s,I,E=null,R,T=null,K=null,ee=null,J,Y,$,N,F=new Je;e({show:(f,c,p)=>(i.value=!0,s=f,I=c,I&&(t.value=!0),E&&(E.setTarget(null),E=null),et(()=>{h(s.resolution),p&&F.addFeature(new Be().readFeature(p))}),new Promise((y,g)=>{$=y,N=g}))});const n=()=>{F.clear(),F.on("addfeature",()=>{E.removeInteraction(T)}),T=new Mo({source:F,type:"Polygon"}),E.addInteraction(T)},o=()=>{F.clear()},d=()=>{o(),i.value=!1,N()},m=()=>{let f=null;F.getFeatures().length>0&&(f=new Be().writeFeature(F.getFeatures()[0],{decimals:4})),$(f),o(),i.value=!1},_=(f,c)=>{F.clear(),F.addFeature(new Be().readFeature(c.features[0]))},h=f=>{if(Y=Ye(s.layerName,s.boundingBox,f),J=new Ze({source:F,style:()=>{var c=new Ce({fill:new St({color:"rgba(255, 0, 0, 0.3)"}),stroke:new Pe({color:"rgba(255, 0, 0, 1)",width:1})});return c}}),E=new Pt({target:"map",layers:[Y,J],view:new Lt({projection:"EPSG:3857"}),controls:Mt({attribution:!1,rotate:!1,zoom:!1})}),R=E.getView(),R.fit(s.boundingBox),ee=new Oo({source:F}),E.addInteraction(ee),K=new Vo({source:F}),E.addInteraction(K),I){let c=Ye(I.layerName,I.boundingBox,f);E.getLayers().insertAt(1,c),c.on("prerender",p=>{var y=p.context,g=E.getSize(),O=g[0]*(r.value/100),G=be(p,[O,0]),te=be(p,[g[0],0]),X=be(p,[O,g[1]]),b=be(p,g);y.save(),y.beginPath(),y.moveTo(G[0],G[1]),y.lineTo(X[0],X[1]),y.lineTo(b[0],b[1]),y.lineTo(te[0],te[1]),y.closePath(),y.clip()}),c.on("postrender",p=>{var y=p.context;y.restore()})}},v=()=>{E&&E.render()};return(f,c)=>{const p=w("el-button"),y=w("el-slider");return H(),ve(je,{name:"el-fade-in-linear"},{default:u(()=>[i.value?(H(),oe("div",Gn,[k("div",$n,[An,k("div",Yn,[a(p,{icon:S(lo),onClick:n},{default:u(()=>[M(" 绘制")]),_:1},8,["icon"]),a(Rt,{onOnSuccess:_},{default:u(()=>[a(p,{icon:S(Ge)},{default:u(()=>[M("上传")]),_:1},8,["icon"])]),_:1}),a(p,{icon:S(It),onClick:o},{default:u(()=>[M(" 清除")]),_:1},8,["icon"]),a(p,{type:"primary",onClick:m},{default:u(()=>[M("确定")]),_:1}),a(p,{type:"primary",icon:S(De),link:"",onClick:d,style:{"font-size":"20px"}},null,8,["icon"])])]),k("div",zn,[t.value?(H(),ve(y,{key:0,id:"slider",modelValue:r.value,"onUpdate:modelValue":c[0]||(c[0]=g=>r.value=g),"show-tooltip":!1,onInput:v},null,8,["modelValue"])):me("",!0)])])):me("",!0)]),_:1})}}});const Yt=kt(Xn,[["__scopeId","data-v-ac58c055"]]),Un=k("template",{slot:"append"},[M("像素")],-1),Dn={style:{display:"flex","align-items":"center","justify-content":"space-between","margin-bottom":"8px"}},jn={class:"flex-gap-8",style:{"justify-content":"flex-end"}},qn={key:0,class:"directory directory_mini"},Hn=k("img",{class:"directory_icon",src:Ft},null,-1),Jn={class:"directory_name"},Zn={key:1,style:{display:"flex","align-items":"center","justify-content":"space-between",width:"100%"}},Wn={class:"directory directory_mini"},Kn=k("img",{class:"directory_icon",src:ze},null,-1),Qn={class:"directory_name"},ea={style:{display:"flex"}},ta=Fe({__name:"CreateInfer",emits:["success"],setup(l,{expose:e,emit:t}){const r=P(!1),i=P("select"),s=P([]),I=({row:f})=>f.error!=null?"warning-row":"",E=f=>{const c=f.name,p=c.substr(c.lastIndexOf(".")+1);if(p=="json"){const y=new FileReader;y.onload=()=>{let O=JSON.parse(y.result);R(O)};const g=f.raw;y.readAsText(g)}else if(p=="xlsx"||p=="xls"){const y=new FileReader;y.onload=()=>{var O=bt(y.result);let G=Me.sheet_to_json(O.Sheets[O.SheetNames[0]]);R(G)};const g=f.raw;y.readAsArrayBuffer(g)}else ce.error("文件格式错误")},R=f=>{Q.post("api/Infer/CheckMultiInfo",f).then(c=>{s.value=c})},T=P();e({show:async f=>{var c;(c=Y.value)==null||c.resetFields(),$.value.type=f,i.value="select",s.value=[],Q.get("api/Model/GetModels",{params:{type:f}}).then(p=>{T.value=p}),r.value=!0}});const ee=P(),J={label:"name",isLeaf:"leaf",disabled:"disabled"},Y=P();let $=P({type:"",modelId:"",tagIds:[],filterPixels:50});const N=Qe({modelId:[{required:!0,message:"请选择模型",trigger:"change"}],tagIds:[{type:"array",required:!0,message:"请选择解译标签",trigger:"change"}],filterPixels:[{required:!0,message:"输入过滤像素阈值",trigger:"change"},{type:"integer",min:0,message:"请输入大于0的整数"}]});let F=P([]);const z=f=>{const c=T.value.find(p=>p.id==f);F.value=c.tags},n=async(f,c)=>{let p;f.level!=0&&(p=f.data.id);let y=await Q.get("api/catalog/GetFolders",{params:{folderId:p}});y.forEach(G=>{G.type="folder",G.disabled=!0});let g=await Q.get("api/catalog/GetImagesInFolder",{params:{folderId:p}});g.forEach(G=>{G.leaf=!0,G.type="image",G.thumbnail=null,G.boundary=null});let O=[...y,...g];return c(O)},o=P(),d=f=>{o.value.show(f,null,f.boundary).then(c=>{f.boundary=c})},m=P(!1),_=async()=>{var c;await((c=Y.value)==null?void 0:c.validate().catch(p=>p))==!0&&(i.value=="select"?v():h())},h=async()=>{if(s.value.length==0){ce("请导入数据");return}let f=s.value.filter(p=>p.error==null);if(f.length==0){ce("没有正确数据，请检查后重新导入");return}if(f.length<s.value.length&&!await $e.confirm("存在错误数据，是否只提交正确数据？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>!0).catch(()=>!1))return;let c=f.map(p=>({ImageFile:p.imageFile,Output:p.output}));m.value=!0,Q.post("api/Infer/CreateMulti",{...$.value,ImageInfoList:c}).then(()=>{ce({message:"任务添加成功",type:"success"}),t("success"),r.value=!1,m.value=!1})},v=async()=>{var y;let f=ee.value.getCheckedNodes(!0);if(f.length==0){ce("请选择数据");return}let c=T.value.find(g=>g.id==$.value.modelId),p=!1;c.minResolution!=null&&c.maxResolution!=null&&f.forEach(g=>{(g.resolution<c.minResolution||g.resolution>c.maxResolution)&&(p=!0)}),!(p&&!await $e.confirm(`选中的影像不适配此模型 ${c.minResolution}米 至 ${c.maxResolution}米 分辨率的范围，继续提交可能导致解译结果不佳，是否继续提交？`,"提示",{confirmButtonText:"继续",cancelButtonText:"取消",type:"warning"}).then(()=>!0).catch(()=>!1))&&((y=Y.value)==null||y.validate(g=>{if(g){let O=f.map(G=>({ImageId:G.id,Boundary:G.boundary}));m.value=!0,Q.post("api/Infer/Create",{...$.value,ImageInfoList:O}).then(()=>{ce({message:"任务添加成功",type:"success"}),t("success"),r.value=!1,m.value=!1})}}))};return(f,c)=>{const p=w("el-option"),y=w("el-select"),g=w("el-form-item"),O=w("el-col"),G=w("el-input"),te=w("el-row"),X=w("el-form"),b=w("el-radio-button"),C=w("el-radio-group"),x=w("el-button"),A=w("el-upload"),D=w("el-tooltip"),de=w("el-tree"),le=w("el-scrollbar"),Le=w("el-link"),j=w("el-alert"),L=w("el-table-column"),B=w("el-table"),Z=w("el-dialog");return H(),oe(xe,null,[a(Z,{title:"新建任务",modelValue:r.value,"onUpdate:modelValue":c[5]||(c[5]=V=>r.value=V),"close-on-click-modal":!1,width:"600px"},{footer:u(()=>[a(x,{onClick:c[4]||(c[4]=V=>r.value=!1)},{default:u(()=>[M("取消")]),_:1}),a(x,{type:"primary",onClick:_,loading:m.value},{default:u(()=>[M("确定")]),_:1},8,["loading"])]),default:u(()=>[a(X,{model:S($),rules:N,ref_key:"formRef",ref:Y,"label-position":"top"},{default:u(()=>[a(g,{label:"解译模型",prop:"modelId"},{default:u(()=>[a(y,{placeholder:"请选择模型",modelValue:S($).modelId,"onUpdate:modelValue":c[0]||(c[0]=V=>S($).modelId=V),style:{width:"100%"},onChange:z},{default:u(()=>[(H(!0),oe(xe,null,Se(T.value,V=>(H(),ve(p,{key:V.id,label:V.modelName,value:V.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(te,{gutter:16},{default:u(()=>[a(O,{span:12},{default:u(()=>[a(g,{label:"解译标签",prop:"tagIds"},{default:u(()=>[a(y,{placeholder:"请选择标签",modelValue:S($).tagIds,"onUpdate:modelValue":c[1]||(c[1]=V=>S($).tagIds=V),multiple:"",style:{width:"100%"}},{default:u(()=>[(H(!0),oe(xe,null,Se(S(F),V=>(H(),ve(p,{key:V.id,label:V.name,value:V.id},{default:u(()=>[a(Zo,{name:V.name,color:V.color,style:{height:"100%"}},null,8,["name","color"])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(O,{span:12},{default:u(()=>[he(a(g,{label:"过滤阈值",prop:"filterPixels"},{default:u(()=>[a(G,{modelValue:S($).filterPixels,"onUpdate:modelValue":c[2]||(c[2]=V=>S($).filterPixels=V),modelModifiers:{number:!0}},{default:u(()=>[Un]),_:1},8,["modelValue"])]),_:1},512),[[_e,S($).type=="seg"]])]),_:1})]),_:1})]),_:1},8,["model","rules"]),k("div",Dn,[a(C,{modelValue:i.value,"onUpdate:modelValue":c[3]||(c[3]=V=>i.value=V)},{default:u(()=>[a(b,{label:"select"},{default:u(()=>[M("选择影像")]),_:1}),a(b,{label:"upload"},{default:u(()=>[M("批量任务")]),_:1})]),_:1},8,["modelValue"]),he(k("div",jn,[a(A,{accept:".json,.xlsx,.xls","auto-upload":!1,"show-file-list":!1,action:"","on-change":E},{default:u(()=>[a(x,{type:"primary",icon:S(Ge),link:""},{default:u(()=>[M("导入数据")]),_:1},8,["icon"])]),_:1})],512),[[_e,i.value=="upload"]])]),he(k("div",null,[a(le,{height:"298px",style:{"background-color":"#ffffff",border:"1px solid #dcdfe6"}},{default:u(()=>[r.value?(H(),ve(de,{key:0,ref_key:"treeRef",ref:ee,props:J,load:n,"node-key":"id","check-strictly":!0,lazy:"","show-checkbox":"","check-on-click-node":""},{default:u(({node:V,data:ie})=>[ie.type==="folder"?(H(),oe("div",qn,[Hn,k("span",Jn,ue(V.label),1)])):(H(),oe("div",Zn,[k("div",Wn,[Kn,k("span",Qn,ue(V.label),1)]),a(D,{content:"解译范围设置",placement:"right"},{default:u(()=>[a(x,{icon:S(io),type:ie.boundary==null?"info":"danger",link:"",style:{"margin-right":"16px"},onClick:so(ae=>d(ie),["stop"])},null,8,["icon","type","onClick"])]),_:2},1024)]))]),_:1},512)):me("",!0)]),_:1})],512),[[_e,i.value=="select"]]),he(k("div",null,[a(j,{type:"info",closable:!1,style:{"margin-bottom":"8px"}},{title:u(()=>[k("div",ea,[M(" 可通过导入 "),a(D,{effect:"light",content:"下载样例数据",placement:"bottom"},{default:u(()=>[a(Le,{type:"primary",href:"Data/Sample/excel.xlsx",target:"_blank"},{default:u(()=>[M("excel")]),_:1})]),_:1}),M(" 创建批量任务 ")])]),_:1}),a(B,{data:s.value,height:"258px",border:"","row-class-name":I},{default:u(()=>[a(L,{type:"index",width:"50"}),a(L,{prop:"imageFile",label:"影像名称"}),a(L,{prop:"output",label:"输出路径"}),a(L,{prop:"error"})]),_:1},8,["data"])],512),[[_e,i.value=="upload"]])]),_:1},8,["modelValue"]),a(Yt,{ref_key:"drawPolygonRef",ref:o},null,512)],64)}}});function _t(l){if(!l)throw new Error("geojson is required");var e=[];return Ee(l,function(t){oa(t,e)}),Ae(e)}function oa(l,e){var t=[],r=l.geometry;if(r!==null){switch(r.type){case"Polygon":t=Re(r);break;case"LineString":t=[Re(r)]}t.forEach(function(i){var s=na(i,l.properties);s.forEach(function(I){I.id=e.length,e.push(I)})})}}function na(l,e){var t=[];return l.reduce(function(r,i){var s=Et([r,i],e);return s.bbox=aa(r,i),t.push(s),i}),t}function aa(l,e){var t=l[0],r=l[1],i=e[0],s=e[1],I=t<i?t:i,E=r<s?r:s,R=t>i?t:i,T=r>s?r:s;return[I,E,R,T]}var nt={exports:{}},zt={exports:{}};(function(l,e){(function(t,r){l.exports=r()})(uo,function(){function t(n,o,d,m,_){(function h(v,f,c,p,y){for(;p>c;){if(p-c>600){var g=p-c+1,O=f-c+1,G=Math.log(g),te=.5*Math.exp(2*G/3),X=.5*Math.sqrt(G*te*(g-te)/g)*(O-g/2<0?-1:1),b=Math.max(c,Math.floor(f-O*te/g+X)),C=Math.min(p,Math.floor(f+(g-O)*te/g+X));h(v,f,b,C,y)}var x=v[f],A=c,D=p;for(r(v,c,f),y(v[p],x)>0&&r(v,c,p);A<D;){for(r(v,A,D),A++,D--;y(v[A],x)<0;)A++;for(;y(v[D],x)>0;)D--}y(v[c],x)===0?r(v,c,D):r(v,++D,p),D<=f&&(c=D+1),f<=D&&(p=D-1)}})(n,o,d||0,m||n.length-1,_||i)}function r(n,o,d){var m=n[o];n[o]=n[d],n[d]=m}function i(n,o){return n<o?-1:n>o?1:0}var s=function(n){n===void 0&&(n=9),this._maxEntries=Math.max(4,n),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function I(n,o,d){if(!d)return o.indexOf(n);for(var m=0;m<o.length;m++)if(d(n,o[m]))return m;return-1}function E(n,o){R(n,0,n.children.length,o,n)}function R(n,o,d,m,_){_||(_=F(null)),_.minX=1/0,_.minY=1/0,_.maxX=-1/0,_.maxY=-1/0;for(var h=o;h<d;h++){var v=n.children[h];T(_,n.leaf?m(v):v)}return _}function T(n,o){return n.minX=Math.min(n.minX,o.minX),n.minY=Math.min(n.minY,o.minY),n.maxX=Math.max(n.maxX,o.maxX),n.maxY=Math.max(n.maxY,o.maxY),n}function K(n,o){return n.minX-o.minX}function ee(n,o){return n.minY-o.minY}function J(n){return(n.maxX-n.minX)*(n.maxY-n.minY)}function Y(n){return n.maxX-n.minX+(n.maxY-n.minY)}function $(n,o){return n.minX<=o.minX&&n.minY<=o.minY&&o.maxX<=n.maxX&&o.maxY<=n.maxY}function N(n,o){return o.minX<=n.maxX&&o.minY<=n.maxY&&o.maxX>=n.minX&&o.maxY>=n.minY}function F(n){return{children:n,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function z(n,o,d,m,_){for(var h=[o,d];h.length;)if(!((d=h.pop())-(o=h.pop())<=m)){var v=o+Math.ceil((d-o)/m/2)*m;t(n,v,o,d,_),h.push(o,v,v,d)}}return s.prototype.all=function(){return this._all(this.data,[])},s.prototype.search=function(n){var o=this.data,d=[];if(!N(n,o))return d;for(var m=this.toBBox,_=[];o;){for(var h=0;h<o.children.length;h++){var v=o.children[h],f=o.leaf?m(v):v;N(n,f)&&(o.leaf?d.push(v):$(n,f)?this._all(v,d):_.push(v))}o=_.pop()}return d},s.prototype.collides=function(n){var o=this.data;if(!N(n,o))return!1;for(var d=[];o;){for(var m=0;m<o.children.length;m++){var _=o.children[m],h=o.leaf?this.toBBox(_):_;if(N(n,h)){if(o.leaf||$(n,h))return!0;d.push(_)}}o=d.pop()}return!1},s.prototype.load=function(n){if(!n||!n.length)return this;if(n.length<this._minEntries){for(var o=0;o<n.length;o++)this.insert(n[o]);return this}var d=this._build(n.slice(),0,n.length-1,0);if(this.data.children.length)if(this.data.height===d.height)this._splitRoot(this.data,d);else{if(this.data.height<d.height){var m=this.data;this.data=d,d=m}this._insert(d,this.data.height-d.height-1,!0)}else this.data=d;return this},s.prototype.insert=function(n){return n&&this._insert(n,this.data.height-1),this},s.prototype.clear=function(){return this.data=F([]),this},s.prototype.remove=function(n,o){if(!n)return this;for(var d,m,_,h=this.data,v=this.toBBox(n),f=[],c=[];h||f.length;){if(h||(h=f.pop(),m=f[f.length-1],d=c.pop(),_=!0),h.leaf){var p=I(n,h.children,o);if(p!==-1)return h.children.splice(p,1),f.push(h),this._condense(f),this}_||h.leaf||!$(h,v)?m?(d++,h=m.children[d],_=!1):h=null:(f.push(h),c.push(d),d=0,m=h,h=h.children[0])}return this},s.prototype.toBBox=function(n){return n},s.prototype.compareMinX=function(n,o){return n.minX-o.minX},s.prototype.compareMinY=function(n,o){return n.minY-o.minY},s.prototype.toJSON=function(){return this.data},s.prototype.fromJSON=function(n){return this.data=n,this},s.prototype._all=function(n,o){for(var d=[];n;)n.leaf?o.push.apply(o,n.children):d.push.apply(d,n.children),n=d.pop();return o},s.prototype._build=function(n,o,d,m){var _,h=d-o+1,v=this._maxEntries;if(h<=v)return E(_=F(n.slice(o,d+1)),this.toBBox),_;m||(m=Math.ceil(Math.log(h)/Math.log(v)),v=Math.ceil(h/Math.pow(v,m-1))),(_=F([])).leaf=!1,_.height=m;var f=Math.ceil(h/v),c=f*Math.ceil(Math.sqrt(v));z(n,o,d,c,this.compareMinX);for(var p=o;p<=d;p+=c){var y=Math.min(p+c-1,d);z(n,p,y,f,this.compareMinY);for(var g=p;g<=y;g+=f){var O=Math.min(g+f-1,y);_.children.push(this._build(n,g,O,m-1))}}return E(_,this.toBBox),_},s.prototype._chooseSubtree=function(n,o,d,m){for(;m.push(o),!o.leaf&&m.length-1!==d;){for(var _=1/0,h=1/0,v=void 0,f=0;f<o.children.length;f++){var c=o.children[f],p=J(c),y=(g=n,O=c,(Math.max(O.maxX,g.maxX)-Math.min(O.minX,g.minX))*(Math.max(O.maxY,g.maxY)-Math.min(O.minY,g.minY))-p);y<h?(h=y,_=p<_?p:_,v=c):y===h&&p<_&&(_=p,v=c)}o=v||o.children[0]}var g,O;return o},s.prototype._insert=function(n,o,d){var m=d?n:this.toBBox(n),_=[],h=this._chooseSubtree(m,this.data,o,_);for(h.children.push(n),T(h,m);o>=0&&_[o].children.length>this._maxEntries;)this._split(_,o),o--;this._adjustParentBBoxes(m,_,o)},s.prototype._split=function(n,o){var d=n[o],m=d.children.length,_=this._minEntries;this._chooseSplitAxis(d,_,m);var h=this._chooseSplitIndex(d,_,m),v=F(d.children.splice(h,d.children.length-h));v.height=d.height,v.leaf=d.leaf,E(d,this.toBBox),E(v,this.toBBox),o?n[o-1].children.push(v):this._splitRoot(d,v)},s.prototype._splitRoot=function(n,o){this.data=F([n,o]),this.data.height=n.height+1,this.data.leaf=!1,E(this.data,this.toBBox)},s.prototype._chooseSplitIndex=function(n,o,d){for(var m,_,h,v,f,c,p,y=1/0,g=1/0,O=o;O<=d-o;O++){var G=R(n,0,O,this.toBBox),te=R(n,O,d,this.toBBox),X=(_=G,h=te,v=void 0,f=void 0,c=void 0,p=void 0,v=Math.max(_.minX,h.minX),f=Math.max(_.minY,h.minY),c=Math.min(_.maxX,h.maxX),p=Math.min(_.maxY,h.maxY),Math.max(0,c-v)*Math.max(0,p-f)),b=J(G)+J(te);X<y?(y=X,m=O,g=b<g?b:g):X===y&&b<g&&(g=b,m=O)}return m||d-o},s.prototype._chooseSplitAxis=function(n,o,d){var m=n.leaf?this.compareMinX:K,_=n.leaf?this.compareMinY:ee;this._allDistMargin(n,o,d,m)<this._allDistMargin(n,o,d,_)&&n.children.sort(m)},s.prototype._allDistMargin=function(n,o,d,m){n.children.sort(m);for(var _=this.toBBox,h=R(n,0,o,_),v=R(n,d-o,d,_),f=Y(h)+Y(v),c=o;c<d-o;c++){var p=n.children[c];T(h,n.leaf?_(p):p),f+=Y(h)}for(var y=d-o-1;y>=o;y--){var g=n.children[y];T(v,n.leaf?_(g):g),f+=Y(v)}return f},s.prototype._adjustParentBBoxes=function(n,o,d){for(var m=d;m>=0;m--)T(o[m],n)},s.prototype._condense=function(n){for(var o=n.length-1,d=void 0;o>=0;o--)n[o].children.length===0?o>0?(d=n[o-1].children).splice(d.indexOf(n[o]),1):this.clear():E(n[o],this.toBBox)},s})})(zt);var ra=zt.exports;const la=Ct(So),Xt=Ct(Bo);var at={};Object.defineProperty(at,"__esModule",{value:!0});var ia=Xt;function We(l){var e=[1/0,1/0,-1/0,-1/0];return ia.coordEach(l,function(t){e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1])}),e}We.default=We;at.default=We;var fe=ra,Ut=la,Dt=Xt,Ie=at.default,sa=Dt.featureEach;Dt.coordEach;Ut.polygon;var gt=Ut.featureCollection;function jt(l){var e=new fe(l);return e.insert=function(t){if(t.type!=="Feature")throw new Error("invalid feature");return t.bbox=t.bbox?t.bbox:Ie(t),fe.prototype.insert.call(this,t)},e.load=function(t){var r=[];return Array.isArray(t)?t.forEach(function(i){if(i.type!=="Feature")throw new Error("invalid features");i.bbox=i.bbox?i.bbox:Ie(i),r.push(i)}):sa(t,function(i){if(i.type!=="Feature")throw new Error("invalid features");i.bbox=i.bbox?i.bbox:Ie(i),r.push(i)}),fe.prototype.load.call(this,r)},e.remove=function(t,r){if(t.type!=="Feature")throw new Error("invalid feature");return t.bbox=t.bbox?t.bbox:Ie(t),fe.prototype.remove.call(this,t,r)},e.clear=function(){return fe.prototype.clear.call(this)},e.search=function(t){var r=fe.prototype.search.call(this,this.toBBox(t));return gt(r)},e.collides=function(t){return fe.prototype.collides.call(this,this.toBBox(t))},e.all=function(){var t=fe.prototype.all.call(this);return gt(t)},e.toJSON=function(){return fe.prototype.toJSON.call(this)},e.fromJSON=function(t){return fe.prototype.fromJSON.call(this,t)},e.toBBox=function(t){var r;if(t.bbox)r=t.bbox;else if(Array.isArray(t)&&t.length===4)r=t;else if(Array.isArray(t)&&t.length===6)r=[t[0],t[1],t[3],t[4]];else if(t.type==="Feature")r=Ie(t);else if(t.type==="FeatureCollection")r=Ie(t);else throw new Error("invalid geojson");return{minX:r[0],minY:r[1],maxX:r[2],maxY:r[3]}},e}nt.exports=jt;nt.exports.default=jt;var ua=nt.exports;const ca=co(ua);function rt(l,e){var t={},r=[];if(l.type==="LineString"&&(l=ut(l)),e.type==="LineString"&&(e=ut(e)),l.type==="Feature"&&e.type==="Feature"&&l.geometry!==null&&e.geometry!==null&&l.geometry.type==="LineString"&&e.geometry.type==="LineString"&&l.geometry.coordinates.length===2&&e.geometry.coordinates.length===2){var i=yt(l,e);return i&&r.push(i),Ae(r)}var s=ca();return s.load(_t(e)),dt(_t(l),function(I){dt(s.search(I),function(E){var R=yt(I,E);if(R){var T=Re(R).join(",");t[T]||(t[T]=!0,r.push(R))}})}),Ae(r)}function yt(l,e){var t=Re(l),r=Re(e);if(t.length!==2)throw new Error("<intersects> line1 must only contain 2 coordinates");if(r.length!==2)throw new Error("<intersects> line2 must only contain 2 coordinates");var i=t[0][0],s=t[0][1],I=t[1][0],E=t[1][1],R=r[0][0],T=r[0][1],K=r[1][0],ee=r[1][1],J=(ee-T)*(I-i)-(K-R)*(E-s),Y=(K-R)*(s-T)-(ee-T)*(i-R),$=(I-i)*(s-T)-(E-s)*(i-R);if(J===0)return null;var N=Y/J,F=$/J;if(N>=0&&N<=1&&F>=0&&F<=1){var z=i+N*(I-i),n=s+N*(E-s);return Eo([z,n])}return null}function Ke(l,e){e===void 0&&(e={});var t=tt(l);switch(!e.properties&&l.type==="Feature"&&(e.properties=l.properties),t.type){case"Polygon":return da(t,e);case"MultiPolygon":return pa(t,e);default:throw new Error("invalid poly")}}function da(l,e){e===void 0&&(e={});var t=tt(l),r=t.coordinates,i=e.properties?e.properties:l.type==="Feature"?l.properties:{};return qt(r,i)}function pa(l,e){e===void 0&&(e={});var t=tt(l),r=t.coordinates,i=e.properties?e.properties:l.type==="Feature"?l.properties:{},s=[];return r.forEach(function(I){s.push(qt(I,i))}),Ae(s)}function qt(l,e){return l.length>1?Ro(l,e):Et(l[0],e)}function fa(l,e){var t=!0;return Ee(l,function(r){Ee(e,function(i){if(t===!1)return!1;t=ma(r.geometry,i.geometry)})}),t}function ma(l,e){switch(l.type){case"Point":switch(e.type){case"Point":return!ya(l.coordinates,e.coordinates);case"LineString":return!vt(e,l);case"Polygon":return!Ne(l,e)}break;case"LineString":switch(e.type){case"Point":return!vt(l,e);case"LineString":return!ha(l,e);case"Polygon":return!xt(e,l)}break;case"Polygon":switch(e.type){case"Point":return!Ne(e,l);case"LineString":return!xt(l,e);case"Polygon":return!_a(e,l)}}return!1}function vt(l,e){for(var t=0;t<l.coordinates.length-1;t++)if(ga(l.coordinates[t],l.coordinates[t+1],e.coordinates))return!0;return!1}function ha(l,e){var t=rt(l,e);return t.features.length>0}function xt(l,e){for(var t=0,r=e.coordinates;t<r.length;t++){var i=r[t];if(Ne(i,l))return!0}var s=rt(e,Ke(l));return s.features.length>0}function _a(l,e){for(var t=0,r=l.coordinates[0];t<r.length;t++){var i=r[t];if(Ne(i,e))return!0}for(var s=0,I=e.coordinates[0];s<I.length;s++){var E=I[s];if(Ne(E,l))return!0}var R=rt(Ke(l),Ke(e));return R.features.length>0}function ga(l,e,t){var r=t[0]-l[0],i=t[1]-l[1],s=e[0]-l[0],I=e[1]-l[1],E=r*I-i*s;return E!==0?!1:Math.abs(s)>=Math.abs(I)?s>0?l[0]<=t[0]&&t[0]<=e[0]:e[0]<=t[0]&&t[0]<=l[0]:I>0?l[1]<=t[1]&&t[1]<=e[1]:e[1]<=t[1]&&t[1]<=l[1]}function ya(l,e){return l[0]===e[0]&&l[1]===e[1]}function va(l,e){var t=!1;return Ee(l,function(r){Ee(e,function(i){if(t===!0)return!0;t=!fa(r.geometry,i.geometry)})}),t}const xa=k("template",{slot:"append"},[M("像素")],-1),ba={style:{display:"flex","align-items":"center","justify-content":"space-between","margin-bottom":"8px"}},wa={class:"flex-gap-8",style:{"justify-content":"flex-end"}},Ta={class:"flex-gap-8",style:{"justify-content":"flex-end"}},ka={key:0},Ia={key:0,class:"directory directory_mini"},Ca=k("img",{class:"directory_icon",src:Ft},null,-1),Pa={class:"directory_name"},La={key:1,style:{display:"flex","align-items":"center","justify-content":"space-between"}},Ma={class:"directory directory_mini"},Sa=k("img",{class:"directory_icon",src:ze},null,-1),Ea={class:"directory_name"},Ra={style:{display:"flex"}},Na=Fe({__name:"CreateChangeInfer",emits:["success"],setup(l,{expose:e,emit:t}){const r=(b,C)=>{let x=[];C.features.forEach(A=>{x.push({ImageFile:A.properties.QSX,NextImageFile:A.properties.HSX,Output:A.properties.Output,Boundary:JSON.stringify(A)})}),Q.post("api/Infer/CheckMultiInfo",x).then(A=>{s.value=A})},i=P("select"),s=P([]),I=({row:b})=>b.error!=null?"warning-row":"",E=b=>{const C=b.name,x=C.substr(C.lastIndexOf(".")+1);if(x=="json"){const A=new FileReader;A.onload=()=>{let de=JSON.parse(A.result);R(de)};const D=b.raw;A.readAsText(D)}else if(x=="xlsx"||x=="xls"){const A=new FileReader;A.onload=()=>{var de=bt(A.result);let le=Me.sheet_to_json(de.Sheets[de.SheetNames[0]]);R(le)};const D=b.raw;A.readAsArrayBuffer(D)}else ce.error("文件格式错误")},R=b=>{Q.post("api/Infer/CheckMultiInfo",b).then(C=>{s.value=C})},T=P(!1),K=P(0),ee={label:"name",isLeaf:"leaf",disabled:"disabled"},J=P([]);e({show:async()=>{var b;(b=F.value)==null||b.resetFields(),Q.get("api/Model/GetModels/",{params:{type:"change"}}).then(C=>{J.value=C}),T.value=!0}});const $=()=>{var b;K.value=0,(b=F.value)==null||b.resetFields(),i.value="select",s.value=[],d=null,m=null,v=null,f.value=!1},N=P(),F=P();let z=P({modelId:"",threshold:.3,filterPixels:50});const n=Qe({modelId:[{required:!0,message:"请选择模型",trigger:"change"}],threshold:[{required:!0,message:"请选择准召率",trigger:"change"}],filterPixels:[{required:!0,message:"输入过滤像素阈值",trigger:"change"},{type:"integer",min:0,message:"请输入大于0的整数"}]}),o=[{value:.1,label:"高召回"},{value:.2,label:"较高召回"},{value:.3,label:"均衡"},{value:.4,label:"较高准确"},{value:.5,label:"高准确"}];let d=null,m=null;const _=P(!1),h=P();let v;const f=P(!1),c=()=>{h.value.show(d,m,v).then(b=>{v=b,f.value=v!=null}).catch(()=>{f.value=v!=null})},p=(b,C)=>{let x=N.value.getCheckedNodes(!0);C?x.length==0?(N.value.filter(null),d=null):x.length==1?(N.value.filter(b),d=b):x.length==2?m=b:x.length>2&&N.value.setCheckedKeys([d.id,m.id]):x.length==1?(d==b&&(d=m),m=null,v=null,f.value=!1):x.length==0&&(d=null,N.value.filter(null)),_.value=d!=null&&m!=null},y=(b,C)=>C.type=="folder"||b==null?!0:va(ct(C.boundingBox),ct(b.boundingBox)),g=async(b,C)=>{let x;b.level!=0&&(x=b.data.id);let A=await Q.get("/api/catalog/GetFolders",{params:{folderId:x}});A.forEach(le=>{le.type="folder",le.disabled=!0});let D=await Q.get("/api/catalog/GetImagesInFolder",{params:{folderId:x}});D.forEach(le=>{le.leaf=!0,le.type="image",le.thumbnail=null,le.boundary=null});let de=[...A,...D];return et(()=>{N.value.filter(d)}),C(de)},O=async()=>{var C;await((C=F.value)==null?void 0:C.validate().catch(x=>x))==!0&&(i.value=="select"?X():te())},G=P(!1),te=async()=>{if(s.value.length==0){ce("请导入数据");return}let b=s.value.filter(x=>x.error==null);if(b.length==0){ce("没有正确数据，请检查后重新导入");return}if(b.length<s.value.length&&!await $e.confirm("存在错误数据，是否只提交正确数据？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>!0).catch(()=>!1))return;let C=b.map(x=>({ImageFile:x.imageFile,NextImageFile:x.nextImageFile,Output:x.output,Boundary:x.boundary}));G.value=!0,Q.post("api/Infer/CreateMulti",{...z.value,Type:"change",ImageInfoList:C}).then(()=>{ce({message:"任务添加成功",type:"success"}),t("success"),T.value=!1,G.value=!1})},X=async()=>{if(d==null||m==null){ce("请选择数据");return}let b=J.value.find(x=>x.id==z.value.modelId),C=!1;if(b.minResolution!=null&&b.maxResolution!=null){let x=Math.max(d.resolution,m.resolution);(x<b.minResolution||x>b.maxResolution)&&(C=!0)}C==!0&&await $e.confirm(`选中的影像不适配此模型 ${b.minResolution}米 至 ${b.maxResolution}米 分辨率的范围，继续提交可能导致解译结果不佳，是否继续提交？`,"提示",{showConfirmButton:!0,confirmButtonText:"继续",cancelButtonText:"取消",type:"warning"}).then(()=>{}).catch(()=>!1)==!1||(G.value=!0,Q.post("/api/Infer/Create",{...z.value,Type:"change",ImageInfoList:[{ImageId:d.id,NextImageId:m.id,Boundary:v}]}).then(()=>{ce({message:"任务添加成功",type:"success"}),t("success"),T.value=!1,G.value=!1}))};return(b,C)=>{const x=w("el-option"),A=w("el-select"),D=w("el-form-item"),de=w("el-input"),le=w("el-col"),Le=w("el-row"),j=w("el-form"),L=w("el-radio-button"),B=w("el-radio-group"),Z=w("el-checkbox"),V=w("el-button"),ie=w("el-upload"),ae=w("el-alert"),re=w("el-tree"),ne=w("el-scrollbar"),ge=w("el-link"),we=w("el-tooltip"),se=w("el-table-column"),pe=w("el-table"),ye=w("el-dialog");return H(),oe(xe,null,[a(ye,{title:"新建任务",modelValue:T.value,"onUpdate:modelValue":C[6]||(C[6]=q=>T.value=q),"close-on-click-modal":!1,width:"600px",onOpen:$},{footer:u(()=>[a(V,{onClick:C[5]||(C[5]=q=>T.value=!1)},{default:u(()=>[M("取消")]),_:1}),a(V,{type:"primary",onClick:O,loading:G.value},{default:u(()=>[M("确定")]),_:1},8,["loading"])]),default:u(()=>[a(j,{model:S(z),rules:n,ref_key:"formRef",ref:F,"label-position":"top"},{default:u(()=>[a(D,{label:"解译模型",prop:"modelId"},{default:u(()=>[a(A,{placeholder:"请选择模型",modelValue:S(z).modelId,"onUpdate:modelValue":C[0]||(C[0]=q=>S(z).modelId=q),style:{width:"100%"}},{default:u(()=>[(H(!0),oe(xe,null,Se(J.value,q=>(H(),ve(x,{key:q.id,label:q.modelName,value:q.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(Le,{gutter:16},{default:u(()=>[a(le,{span:12},{default:u(()=>[a(D,{label:"过滤阈值",prop:"filterPixels"},{default:u(()=>[a(de,{modelValue:S(z).filterPixels,"onUpdate:modelValue":C[1]||(C[1]=q=>S(z).filterPixels=q),modelModifiers:{number:!0}},{default:u(()=>[xa]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(le,{span:12},{default:u(()=>[a(D,{label:"置信度",prop:"threshold"},{default:u(()=>[a(A,{placeholder:"请选择置信度",modelValue:S(z).threshold,"onUpdate:modelValue":C[2]||(C[2]=q=>S(z).threshold=q),style:{width:"100%"}},{default:u(()=>[(H(),oe(xe,null,Se(o,(q,Te)=>a(x,{key:Te,label:q.label,value:q.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","rules"]),k("div",ba,[a(B,{modelValue:i.value,"onUpdate:modelValue":C[3]||(C[3]=q=>i.value=q)},{default:u(()=>[a(L,{label:"select"},{default:u(()=>[M("选择影像")]),_:1}),a(L,{label:"upload"},{default:u(()=>[M("批量任务")]),_:1})]),_:1},8,["modelValue"]),he(k("div",wa,[a(Z,{modelValue:f.value,"onUpdate:modelValue":C[4]||(C[4]=q=>f.value=q),onChange:c,disabled:!_.value},{default:u(()=>[M("解译范围设置")]),_:1},8,["modelValue","disabled"])],512),[[_e,i.value=="select"]]),he(k("div",Ta,[a(ie,{accept:".json,.xlsx,.xls","auto-upload":!1,"show-file-list":!1,action:"","on-change":E},{default:u(()=>[a(V,{type:"primary",icon:S(Ge),link:""},{default:u(()=>[M("导入数据")]),_:1},8,["icon"])]),_:1}),a(Rt,{onOnSuccess:r},{default:u(()=>[a(V,{type:"primary",icon:S(Ge),link:""},{default:u(()=>[M("导入镶嵌数据")]),_:1},8,["icon"])]),_:1})],512),[[_e,i.value=="upload"]])]),T.value?he((H(),oe("div",ka,[a(ae,{title:"请选择两幅影像，选择第一幅影像后会筛选出与之有重叠区域的影像",type:"info",closable:!1,style:{"margin-bottom":"8px"}}),a(ne,{height:"298px",style:{"background-color":"#ffffff",border:"1px solid #dcdfe6"}},{default:u(()=>[a(re,{ref_key:"firstImageTree",ref:N,"node-key":"id",props:ee,load:g,"filter-node-method":y,"check-strictly":!0,onCheckChange:p,lazy:"","show-checkbox":"","check-on-click-node":""},{default:u(({node:q,data:Te})=>[Te.type==="folder"?(H(),oe("div",Ia,[Ca,k("span",Pa,ue(q.label),1)])):(H(),oe("div",La,[k("div",Ma,[Sa,k("span",Ea,ue(q.label),1)])]))]),_:1},512)]),_:1})],512)),[[_e,i.value=="select"]]):me("",!0),he(k("div",null,[a(ae,{type:"info",closable:!1,style:{"margin-bottom":"8px"}},{title:u(()=>[k("div",Ra,[M(" 可通过导入 "),a(we,{effect:"light",content:"下载样例数据",placement:"bottom"},{default:u(()=>[a(ge,{type:"primary",href:"Data/Sample/change_excel.xlsx",target:"_blank"},{default:u(()=>[M("excel")]),_:1})]),_:1}),M(" 创建批量任务 ，导入 "),a(we,{effect:"light",content:"下载样例数据",placement:"bottom"},{default:u(()=>[a(ge,{type:"primary",href:"Data/Sample/shapefile.zip",target:"_blank"},{default:u(()=>[M("shapefile")]),_:1})]),_:1}),M(" 创建镶嵌任务 ")])]),_:1}),a(pe,{data:s.value,height:"300px",border:"","row-class-name":I},{default:u(()=>[a(se,{type:"index",width:"50"}),a(se,{prop:"imageFile",label:"前时相"}),a(se,{prop:"nextImageFile",label:"后时相"}),a(se,{prop:"output",label:"输出路径"}),a(se,{prop:"error"})]),_:1},8,["data"])],512),[[_e,i.value=="upload"]])]),_:1},8,["modelValue"]),a(Yt,{ref_key:"drawPolygonRef",ref:h},null,512)],64)}}}),Fa={class:"flex-gap-8"},Oa=k("i",{class:"iconfont icon-stop"},null,-1),Va={class:"directory"},Ba=k("img",{class:"directory_icon",src:ze},null,-1),Ga={class:"directory_name"},$a={key:0,class:"directory",style:{"margin-top":"4px"}},Aa=k("img",{class:"directory_icon",src:ze},null,-1),Ya={class:"directory_name"},za={class:"table-footer"},rr=Fe({__name:"Index",props:{taskType:{type:String}},setup(l){const e=l,{taskTypeList:t,getTaskTypeName:r}=Wo(),i=P(""),s=P([]),I=P([]);po(()=>e.taskType,()=>{N()});const E=Ue(()=>t.find(c=>c.name==e.taskType));let R;fo(()=>{N(),R=new Qo().withAutomaticReconnect().withUrl(mo+"/TaskHub").build(),R.start().catch(c=>{console.log("🚀 ~ file: Index.vue:166 ~ mounted ~ error:",c)}),R.on("GetProgress",(c,p,y)=>{let g=s.value.find(O=>O.id==c);g.progress=y,g.status=p,p==Oe.Success&&N()})}),ho(()=>{R.off("GetProgress")});const T=Ue(()=>s.value.filter(c=>!i.value||c.imageName.toLowerCase().includes(i.value.toLowerCase())||c.nextImageName.toLowerCase().includes(i.value.toLowerCase())||c.modelName.toLowerCase().includes(i.value.toLowerCase()))),K=c=>{I.value=c},ee=Ue(()=>I.value.map(c=>c.id)),J=P(1),Y=P(100),$=P(0),N=()=>{Q.get(`api/Infer/GetList/${e.taskType}`,{params:{page:J.value,size:Y.value}}).then(c=>{c.datas.forEach(p=>{p.progress=p.status===Oe.Success?100:0}),s.value=c.datas,$.value=c.total})},F=P(),z=P(),n=()=>{e.taskType==="change"?z.value.show():F.value.show(e.taskType)},o=c=>{Q({method:"POST",url:"api/infer/delete",data:[c.id]}).then(()=>{N()})},d=c=>{Q({method:"POST",url:"api/infer/stop",data:[c.id]}).then(()=>{N()})},m=()=>{Q({method:"POST",url:"api/infer/stop",data:ee.value}).then(()=>{N()})},_=()=>{Q({method:"POST",url:"api/infer/delete",data:ee.value}).then(()=>{N()})},h=P(),v=c=>{h.value.show(c)},f=()=>{var c="任务信息.xls",p=Me.book_new();let y=JSON.parse(JSON.stringify(I.value));const g=["id","modelName","imageName","nextImageName","status","type","progress","created","completed"];y.forEach(X=>{Object.keys(X).forEach(b=>{if(g.includes(b)||delete X[b],b=="status"){let C=X[b];X[b]=Oe[C]}if(b=="type"){let C=X[b];X[b]=r(C)}})});const G=[{id:"id",modelName:"模型名称",imageName:"前时相",nextImageName:"后时相",status:"状态",type:"类型",progress:"进度",created:"创建时间",completed:"完成时间"},...y];var te=Me.json_to_sheet(G,{header:g,skipHeader:!0});Me.book_append_sheet(p,te,"Sheet1"),Kt(p,c)};return(c,p)=>{const y=w("el-button"),g=w("el-popconfirm"),O=w("el-button-group"),G=w("el-input"),te=w("el-divider"),X=w("el-table-column"),b=w("el-table"),C=w("el-pagination");return H(),oe(xe,null,[a(xo,_o(go(E.value)),null,16),k("div",Fa,[a(y,{type:"primary",icon:S(yo),onClick:n},{default:u(()=>[M("新建任务")]),_:1},8,["icon"]),a(O,null,{default:u(()=>[a(g,{width:"170","confirm-button-text":"终止","cancel-button-text":"取消",title:"确认终止所选任务么?",onConfirm:m},{reference:u(()=>[a(y,{type:"primary",plain:"",disabled:I.value.length==0},{default:u(()=>[Oa,M(" 终止")]),_:1},8,["disabled"])]),_:1}),a(g,{width:"170","confirm-button-text":"删除","cancel-button-text":"取消",title:"确认删除所选任务么?",onConfirm:_},{reference:u(()=>[a(y,{type:"primary",icon:S(It),plain:"",disabled:I.value.length==0},{default:u(()=>[M("删除")]),_:1},8,["icon","disabled"])]),_:1}),a(y,{type:"primary",icon:S(vo),disabled:I.value.length==0,onClick:f,plain:""},{default:u(()=>[M("导出")]),_:1},8,["icon","disabled"])]),_:1}),a(G,{modelValue:i.value,"onUpdate:modelValue":p[0]||(p[0]=x=>i.value=x),modelModifiers:{trim:!0},style:{width:"300px"},placeholder:"搜索您的任务",clearable:""},null,8,["modelValue"])]),a(te),a(b,{data:T.value,height:"calc(100vh - 250px)",onSelectionChange:K},{default:u(()=>[a(X,{type:"selection"}),a(X,{type:"index",width:"50"}),a(X,{label:"文件名","show-overflow-tooltip":""},{default:u(x=>[k("div",null,[k("div",Va,[Ba,k("span",Ga,ue(x.row.imageName),1)]),x.row.nextImageName?(H(),oe("div",$a,[Aa,k("span",Ya,ue(x.row.nextImageName),1)])):me("",!0)])]),_:1}),a(X,{prop:"modelName",label:"模型名称","show-overflow-tooltip":""}),a(X,{prop:"progress",label:"状态",width:"170"},{default:u(x=>[a(Ko,{id:x.row.id,type:"infer",status:x.row.status,progress:x.row.progress},null,8,["id","status","progress"])]),_:1}),a(X,{prop:"created",label:"提交时间",sortable:"",width:"140"}),a(X,{prop:"completed",label:"结束时间",sortable:"",width:"140"}),a(X,{width:"150","class-name":"hover-to-show"},{default:u(x=>[a(y,{type:"primary",link:"",onClick:A=>v(x.row)},{default:u(()=>[M("详情")]),_:2},1032,["onClick"]),a(g,{width:"170","confirm-button-text":"终止","cancel-button-text":"取消",title:"确认终止此任务么?",onConfirm:A=>d(x.row)},{reference:u(()=>[a(y,{type:"warning",link:"",disabled:x.row.status>S(Oe).Running},{default:u(()=>[M("终止")]),_:2},1032,["disabled"])]),_:2},1032,["onConfirm"]),a(g,{width:"170","confirm-button-text":"删除","cancel-button-text":"取消",title:"确认删除此任务么?",onConfirm:A=>o(x.row)},{reference:u(()=>[a(y,{type:"danger",link:""},{default:u(()=>[M("删除")]),_:1})]),_:2},1032,["onConfirm"])]),_:1})]),_:1},8,["data"]),k("div",za,[a(C,{"current-page":J.value,"onUpdate:currentPage":p[1]||(p[1]=x=>J.value=x),"page-size":Y.value,"onUpdate:pageSize":p[2]||(p[2]=x=>Y.value=x),"page-sizes":[50,100,200,500],total:$.value,background:"",layout:"sizes, total, prev, pager, next",small:"",onCurrentChange:N,onSizeChange:N},null,8,["current-page","page-size","total"])]),a(ta,{ref_key:"createInferRef",ref:F,onSuccess:N},null,512),a(Na,{ref_key:"createChangeInferRef",ref:z,onSuccess:N},null,512),a(Vn,{ref_key:"inferResultRef",ref:h},null,512)],64)}}});export{rr as default};
